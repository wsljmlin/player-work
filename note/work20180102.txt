20180102 9:15-

cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
echo performance > /sys/devices/system/cpu/cpufreq/policy0/scaling_governor
echo 3 > /sys/class/mpgpu/scale_mode
echo  3 > /sys/class/mpgpu/cur_freq

1. 查看当前gpu的频率。
3.0, 3.8, 3.10:   echo clk  > /sys/class/amlogic/debug | grep mali

2. 调整gpu的频率, 250M-510M
echo 2 > /sys/class/mpgpu/scale_mode
echo  clk_index > /sys/class/mpgpu/cur_freq
clk_index     freq
0             	182Mhz
1 	318Mhz
2 	425Mhz
3 	510Mhz

3. 调整gpu的频率, 637M
echo 3 > /sys/class/mpgpu/scale_mode

4.调整clock之后，用第一步，检查gpu的clock是否和自己期望的频率相同，如果不同，请咨询zengtao如何关闭温控。


error: device/amlogic/: branch o-amlogic is published (but not merged) and is now 8 commits behind
error: hardware/amlogic/media_modules/: platform/hardware/amlogic/media_modules checkout 63b704ea12605047d25edcde4ebc2ff65a3068e1

cat /sys/class/thermal/thermal_zone0/temp
while true; do sleep 1; cat /sys/class/thermal/thermal_zone0/temp; done &

1.内存
while true; do  cat /sys/class/codec_mm/codec_mm_dump;procrank; done &

while true; do  cat /sys/class/codec_mm/codec_mm_dump; done &
codec mem info:
        total codec mem size:308 MB
        alloced size= 21 MB
        max alloced: 109 MB
        CMA:21,RES:0,TVP:0,SYS:0 MB
        [4]CMA size:308 MB:alloced: 21 MB,free:286 MB
        [1].0:ION.0,addr=0000000020800000,size=3112960,from=4,cnt=1,flags=3,used:2296 ms
        [2].0:ION.0,addr=0000000020af8000,size=3112960,from=4,cnt=1,flags=3,used:2294 ms
        [3].0:ION.0,addr=0000000020df0000,size=3112960,from=4,cnt=1,flags=3,used:2293 ms
        [4].0:ION.0,addr=00000000210e8000,size=3112960,from=4,cnt=1,flags=3,used:2291 ms
        [5].0:ION.0,addr=00000000213e0000,size=3112960,from=4,cnt=1,flags=3,used:2290 ms
        [6].0:ION.0,addr=00000000216d8000,size=3112960,from=4,cnt=1,flags=3,used:2288 ms
        [245].0:ammvdec_h264.65,addr=00000000219d0000,size=2097152,from=4,cnt=1,flags=69633,used:18 ms
        [246].0:VFRAME_INPUT.0,addr=0000000021bd0000,size=524288,from=4,cnt=1,flags=4099,used:14 ms
        [247].0:VFRAME_INPUT.0,addr=0000000021c50000,size=524288,from=4,cnt=1,flags=4099,used:13 ms
        [248].0:VFRAME_INPUT.0,addr=0000000021cd0000,size=524288,from=4,cnt=1,flags=4099,used:13 ms
                total        used        free      shared     buffers
Mem:       1033175040   943640576    89534464     2408448     3432448
-/+ buffers/cache:      940208128    92966912
Swap:       524283904     1368064   522915840

2.top看cpu占用很高cpu温度
while true; do sleep 0.2; cat /sys/class/thermal/thermal_zone0/temp; done &

闪动
1.osd层和video层显示都这问题
2.提交mali频率
echo 2 > /sys/class/mpgpu/scale_mode
echo  3 > /sys/class/mpgpu/cur_freq
3.调整中断
  7:      43155          0          0          0     GIC-0 192 Level     Mali_GP
  8:          0          0          0          0     GIC-0 193 Level     Mali_GP_MMU
  9:      22956          0          0          0     GIC-0 194 Level     Mali_PP_Broadcast
4.
1.vdec urgent 补丁
2.skip B补丁
3.抽线：echo 1 > /sys/module/amvideo/parameters/force_vskip_cnt 
cat /proc/irq/76/smp_affinity
echo 7 > /proc/irq/7/smp_affinity
echo 9 > /proc/irq/7/smp_affinity

setenv EnableSelinux permissive
dts目录“common/arch/arm64/boot/dts/amlogic

cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
echo performance > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor

./ddb_v2_n -c 0x1ffff 0x6ffff 0x2010ffff 0x700ffff -t 59768832 -n 600 -f /data/test/ddrBW.csv 
./ddb -c 0x1ffff 0x6ffff 0x2010ffff 0x700ffff -t 59768832 -n 600 -f /data/test/ddrBW_videodibypass.csv -u   //264
./ddb -c 0x1ffff 0x6ffff 0x2010ffff 0x700ffff -t 59768832 -n 600 -f /data/test/ddrBW_videodibypass.csv -v //vp9/h265

总线拉死
具体来说是在外设的clk并关闭后，总线上有访问外设寄存器的现象发生，而外设的ACK迟迟没有返回，下一波的寄存器访问又开始了，导致总线被拉死


echo 1 > /sys/module/amvdec_mh264/parameters/wsldbg
echo 2 > /sys/module/amvdec_mh264/parameters/wsldbg
echo 1 >/sys/module/di/parameters/bypass_all
cat /sys/module/di/parameters/bypass_state
echo 1 > /sys/class/graphics/fb0/blank

dumpsys SurfaceFlinger --latency-clear， dumpsys SurfaceFlinger --latency
dumpsys SurfaceFlinger --latency-clear
dumpsys SurfaceFlinger --latency "org.xbmc.kodi/org.xbmc.kodi.Main#0"
dumpsys SurfaceFlinger --latency " com.google.android.youtube.tv/com.google.android.apps.youtube.tv.activity.MainActivity#0"

chmod 644 /sys/module/mali/parameters/mali_l2_max_reads
echo 4 > /sys/module/mali/parameters/mali_l2_max_reads
chmod 400 /sys/module/mali/parameters/mali_l2_max_reads

/sys/module/mali/parameters/mali_l2_max_reads
/sys/class/mpgpu/l2_max_reads

echo 2 > /sys/class/mpgpu/scale_mode
chmod 600 /sys/class/mpgpu/scale_mode
echo 1 > /sys/kernel/debug/mali/pp/num_cores_enabled

while true; do cat /sys/kernel/debug/mali/utilization_pp; cat /sys/kernel/debug/mali/utilization_gp;cat /sys/kernel/debug/mali/utilization_gp_pp;cat /sys/kernel/debug/aml_clkmsr/clkmsr | grep mali;sleep 0.5; done

echo 6 > /sys/module/amvdec_mh264/parameters/wsldbg

error: common/: branch n-amlogic is published (but not merged) and is now 23 commits behind
error: frameworks/av/: branch n-amlogic is published (but not merged) and is now 13 commits behind
error: frameworks/native/: branch n-amlogic is published (but not merged) and is now 1 commits behind

tftp -r wangcfg_board.rc -g 10.68.8.68

http://scgit.amlogic.com:8080/36478 
http://scgit.amlogic.com:8080/36480
如果ffmpeg没有解析出来音频的channel count，默认设置为2。这个问题是zhulianlian把adts和aac的解码改用softamadec后，针对个别流ffmpeg没解析出channel count才出现的

openlinux_sdk.xml

echo 0x20000 > /sys/module/amvideo/parameters/debug_flag
echo 0x800000 > /sys/module/amvideo/parameters/debug_flag

20180111 9:15-
http://scgit.amlogic.com:8080/#/c/36417/ 小米1080p 60fps视频丢帧，增加解码buffer 6->8
http://scgit.amlogic.com:8080/#/c/36685/ h264 libplayer seek后出现pts和pts_64对应不上了，pts修改有误
http://scgit.amlogic.com:8080/36568，这个omx m-xiaom-m12分支合了一个master的一个patch，PD#136506: secure input buffer 1900KB * 4 -> 3000KB * 2这个的

echo 0x800000 > /sys/module/amvideo/parameters/debug_flag

dumpsys SurfaceFlinger --latency "org.xbmc.kodi/org.xbmc.kodi.Main#0"
dumpsys SurfaceFlinger --latency "com.droidlogic.videoplayer/com.droidlogic.videoplayer.VideoPlayer#0"

setprop media.omx.osd_maxwidth 1920
setprop media.omx.osd_maxheight 1088

git log --committer="Stark Li <stark.li@amlogic.com>"

测试视频为1920x1080@25fps h264，在p241已经为video layer播放，为复现问题，本地做经下尝试
1.p241和p212分别使用最新openlinux code以及自己编译的trunk代码，p212 hdmi输出切换到1080p@60hz(p241默认最大输出1080p@60hz)，两者相同的现象，没有出现抖、卡顿的现象
http://firmware.myamlogic.com/shenzhen/image/android/Android-O/Openlinux/BOX/Android_TV/trunk/2018-01-12/p241-user-32-GTVS-133/
http://firmware.myamlogic.com/shenzhen/image/android/Android-O/Openlinux/BOX/Android_TV/trunk/2018-01-12/p212-user-64-GTVS-133/
http://firmware.myamlogic.com/shanghai/image/android/Android-O/BOX//patchbuild/2018-01-11/p241-userdebug-64-DRM-1498/
http://firmware.myamlogic.com/shanghai/image/android/Android-O/BOX//patchbuild/2018-01-11/p212-userdebug-64-DRM-1499/
2.更新电视和板卡，更换两块p241板卡（v1和v2各1），4k电视更换3个（小米电视、Philips、skyworth），p241上没有复现抖、卡顿现象

tingting尝试
1.更换2个电视（skyworth、LG），更换p241板卡，问题还是能复现
2.dibypass、nr disable、rdma disable，没有效果
3.把视频从u盘copy到mmc，还是能复现
4.把p212的hdmi输出从2k4k@30HZ切换到108P@60HZ，p212板卡同样出现抖、卡顿的现象
5.把p241的hdmi输出从1080P@60Z切换到1080P@xxZ
6.更换hdmi线，还是同样的现象
7.movieplayer播放也同样的现象


Bug 158521 - {GTVS_8.0}[full treble]Netflix播放Moving Art和House Of Cards视频多次卡住之后继续播放。概率：5%，对比：Nexus（8.0）有此问题，shield（7.0）无此问题 
Bug 158517 - {GTVS_8.0}[full treble]Netflix播放Example Short 24视频抖动，退出再次播放正常。概率：20%，对比：Nexus（8.0）有此问题，shield（7.0）无此问题
Bug 158453 - {GTVS_8.0}[full treble]Netflix播放El Fuente：25 main视频卡住死机。概率：出现1次，对比：无需对比
Bug 158456 - {GTVS_8.0}[full treble]Netflix播放El Fuente series视频，起播或播放过程中出现卡住或提示播放错误。概率：30%，对比：Google盒子无此问题，openlinux20171216无此问题
Bug 158530 - [P256-客户反馈#3892-video]:[Netflix] Unable to play video track, when Netflix is launched after youtube video is played


2-180116
16-1. 出现视频卡住， repeat没用

1.
Amessage出现异常
20180117_4.log 
20180117_5.log 

20180118
debug gerrit
http://scgit.amlogic.com:8080/37157

1.patchbuild 
http://jenkins-sh.amlogic.com:8080/job/android/job/Android_O/job/Android_O_PATCHBUILD_MBOX/1543/console

2.

echo 0x800000 > /sys/module/amvideo/parameters/debug_flag
echo 0 > /sys/module/amvideo/parameters/debug_flag
dmesg -c > /dev/null && echo 0x800000 > /sys/module/amvideo/parameters/debug_flag

http://firmware.myamlogic.com/shenzhen/image/android/Android-N/BOX/openlinux/openlinux-0606/2018-01-19/p212-user-64-ATV-414/

20180122
echo 1 > /sys/module/amvdec_mh264/parameters/wsldbg
echo 2 > /sys/module/amvdec_mh264/parameters/wsldbg

echo 3 > /sys/module/amvdec_mh264/parameters/wsldbg


ddb -c 0x1ffff 0x6ffff 0x2010ffff 0x700ffff -t 59768832 -n 600 -f ddrBW.csv  -v

setprop   debug.stagefright.omx-debug 5
setprop media.omx.log_levels  255
ount -o rw,remount /dev/block/system  /system

nts抖动
1.没有di
p212:/data/test/20180122 # cat /sys/class/vfm/map                              
[00]  default { decoder(1) amlvideo(1) amvideo}
[01]  default_amlvideo2 { vdin1(0) amlvideo2.1}
[02]  dvhdmiin { dv_vdin(0) amvideo}
2.pcr pts 显示正常



[  297.398572@2] W Timeout, but fetch ok,[  297.398673@0] type 4 len=72,wpdiff=-72, isphy 0
[  298.122608@1] W Timeout, but fetch ok,[  298.122842@3] type 4 len=72,wpdiff=-72, isphy 0
[  299.374495@0] W Timeout, but fetch ok,[  299.374538@2] type 4 len=72,wpdiff=-72, isphy 0
[  301.342536@0] W Timeout, but fetch ok,[  301.342612@0] type 4 len=72,wpdiff=-72, isphy 0
[  301.730563@0] W Timeout, but fetch ok,[  301.730624@3] type 4 len=72,wpdiff=-72, isphy 0
[  304.722573@1] W Timeout, but fetch ok,[  304.722638@2] type 4 len=72,wpdiff=-72, isphy 0
[  305.310528@1] W Timeout, but fetch ok,[  305.310594@0] type 4 len=72,wpdiff=-72, isphy 0
[  307.350492@0] W Timeout, but fetch ok,[  307.350536@1] type 4 len=72,wpdiff=-72, isphy 0
[  309.346604@3] W Timeout, but fetch ok,[  309.346684@0] type 4 len=72,wpdiff=-72, isphy 0
[  309.902820@0] W Timeout, but fetch ok,[  309.903053@2] type 4 len=72,wpdiff=-72, isphy 0
[  314.566516@1] W Timeout, but fetch ok,[  314.566559@2] type 4 len=72,wpdiff=-72, isphy 0
[  314.898566@0] W Timeout, but fetch ok,[  314.898667@1] type 4 len=72,wpdiff=-72, isphy 0
[  315.206517@2] W Timeout, but fetch ok,[  315.206556@1] type 4 len=72,wpdiff=-72, isphy 0
[  315.514525@0] W Timeout, but fetch ok,[  315.514598@0] type 4 len=72,wpdiff=-72, isphy 0
[  318.750564@1] W Timeout, but fetch ok,[  318.750604@2] type 4 len=72,wpdiff=-72, isphy 0
[  319.514494@1] W Timeout, but fetch ok,[  319.514529@2] type 4 len=72,wpdiff=-72, isphy 0
[  321.366816@2] W Timeout, but fetch ok,[  321.366923@3] type 4 len=72,wpdiff=-72, isphy 0
[  321.950525@3] W Timeout, but fetch ok,[  321.950574@1] type 4 len=72,wpdiff=-72, isphy 0
[  322.562818@2] W Timeout, but fetch ok,[  322.562928@2] type 4 len=72,wpdiff=-72, isphy 0

		
2.codcec_mm内存确认，通过以下两种方法确认内存，应该可以排除内存问题
1）通过在ammvdec_h264_prober结尾处调用dump_mem_infos查看code_mm内存
2）while true; do  cat /sys/class/codec_mm/codec_mm_dump;free; done &

最后一次probe时的打印log如下
[  108.683684@3] codec mem info:
[  108.683684@3]        total codec mem size:120 MB
[  108.683684@3]        alloced size= 2 MB
[  108.683684@3]        max alloced: 91 MB
[  108.683684@3]        CMA:2,RES:0,TVP:0,SYS:0 MB
[  108.683684@3]        [4]CMA size:120 MB:alloced: 2 MB,free:118 MB
[  108.683693@3]        [362].0:ammvdec_h264.65,addr=000000002c400000,size=2097152,from=4,cnt=1,flags=69633,used:2 ms

使用命令抓取的最后一次打印如下
                total        used        free      shared     buffers
Mem:       1033097216   998637568    34459648     2547712     9064448
-/+ buffers/cache:      989573120    43524096
Swap:       524283904     2441216   521842688
codec mem info:
        total codec mem size:120 MB
        alloced size= 90 MB
        max alloced: 90 MB
        CMA:90,RES:0,TVP:0,SYS:0 MB
        [4]CMA size:120 MB:alloced: 90 MB,free:29 MB
        [61].0:ammvdec_h264.65,addr=000000002c400000,size=2097152,from=4,cnt=1,flags=69633,used:181 ms
        [65].0:ammvdec_h264.0,addr=000000002c780000,size=3133440,from=4,cnt=1,flags=69633,used:15

3.top看cpu占用很高，确认下cpu温度，温度没有异常
while true; do sleep 0.2; cat /sys/class/thermal/thermal_zone0/temp; done &
log如下
60000
60000
60000
[  109.677336@3] 0: mb height/widht/total: 44/78/1fe0 level_idc 0 max_ref_num 2
[  109.734316@1] success set parent gpu_p1_composite rate to 400000000


[  470.194162@3] power down and up
[  470.312427@3] is_reset=1
[  470.374866@3] internal phy init
[  470.374903@3] reset phy

4.尝试把vmh264.c和vdec.c中其它可能操作寄存器的函数添加debug信息，没有发现死在其中的地方。
5.由于是osd和video layer层播放会有死机的问题，可以排除amvideo和deinterlace模块的问题。
6.vmh264和vh264，frame和stream mode都会这死机的问题，还有就是解码器的头已经解出来，拉死总线的就不一定是解码器的，还需要确认下其它模块

am start -n com.android.gallery3d/com.android.gallery3d.app.MovieActivity http://10.18.11.251/tv_qatest/dash/h264_mp4/mp4-main-multi-mpd-AV-BS.mpd

setprop media.hls.read_pts 1

sourcesight 3.5 SI3US-361500-17409


1.把昨天ABuffer的patch去掉
2.setprop media.hls.ptsdebug 4
  setprop media.omx.log_levels 255
 
 
 setprop media.omx.log_levels 255
 setprop media.hls.ptsdebug 4
 logcat -v time | grep -v "Layer"
 
 while [ true ];do procrank; sleep 20; done &
 
 http://scgit.amlogic.com:8080/38478
 http://scgit.amlogic.com:8080/37963


10.28.8.19
xiaojing.huang
2@Logon123 如果密码不对那就：%k0dTIP
件夹登录的话：
10.28.8.3
xiaojing.huang
%k0dTIP
2018/2/7 10:23:33
aml 2018/2/7 10:23:33
客户的代码路径是pbs-6.0
编译方法是 
. 1.0x_cn_env.sh
make otapackage


logcat | grep -v AM_DEBUG | grep -v readMessage

android O
add more format support [1/12]  				http://scgit.amlogic.com:8080/#/c/35028/ 
add more format support for o [2/12]  			http://scgit.amlogic.com:8080/#/c/35027/
avs : fix omx+avs seek problem [3/12]			http://scgit.amlogic.com:8080/#/c/35024/
add mediaext3 [4/12] 							http://scgit.amlogic.com:8080/#/c/34875/
add mediaext3 [5/12] 							http://scgit.amlogic.com:8080/#/c/34469/
fix compile error at sometime [6/12] 			http://scgit.amlogic.com:8080/#/c/34877/
mediaext: add for media extensions [7/12] 		http://scgit.amlogic.com:8080/#/c/33194/
mediaext: add for media extension [8/12] 		http://scgit.amlogic.com:8080/#/c/33776/
mediaext: add media ext [9/12] 					http://scgit.amlogic.com:8080/#/c/34470/
add more format support for o [10/12] 			http://scgit.amlogic.com:8080/#/c/34885/
add more format support [11/12] 				http://scgit.amlogic.com:8080/#/c/34881/
add some format support [12/12] 				http://scgit.amlogic.com:8080/#/c/34882/
mediaext: add amnuplayer avenhancements 		http://scgit.amlogic.com:8080/#/c/34139/
update for o bringup 							http://scgit.amlogic.com:8080/#/c/34123/
add o media bringup 							http://scgit.amlogic.com:8080/#/c/34444/

android O amnuplayer
mediaext: add amnuplayer avenhancements 		http://scgit.amlogic.com:8080/#/c/34139/		vendor/amlogic/prebuilt/libmedia
mediaext: add for media extensions [7/12] 		http://scgit.amlogic.com:8080/#/c/33194/		platform/frameworks/av
add mediaext3 [5/12] 							http://scgit.amlogic.com:8080/#/c/34469/		device/amlogic-o
mediaext: add for media extension [8/12] 		http://scgit.amlogic.com:8080/#/c/33776/		platform/manifest
mediaext: add media ext [9/12] 					http://scgit.amlogic.com:8080/#/c/34470/		platform/manifest
add more format support for o [2/12]  			http://scgit.amlogic.com:8080/#/c/35027/		vendor/amlogic/prebuilt/libstagefrighthw
add more format support [1/12]  				http://scgit.amlogic.com:8080/#/c/35028/		vendor/amlogic/prebuilt/libmedia
fix compile error at sometime [6/12] 			http://scgit.amlogic.com:8080/#/c/34877/		vendor/amlogic/frameworks/av
add mediaext3 [4/12] 							http://scgit.amlogic.com:8080/#/c/34875/		platform/hardware/amlogic/media
avs : fix omx+avs seek problem [3/12]			http://scgit.amlogic.com:8080/#/c/35024/		platform/hardware/amlogic/media_modules

源码
add more format support for o [10/12] 			http://scgit.amlogic.com:8080/#/c/34885/		av-restricted/platform/hardware/amlogic/omx
add more format support [11/12] 				http://scgit.amlogic.com:8080/#/c/34881/		av-restricted/platform/vendor/amnuplayer
add some format support [12/12] 				http://scgit.amlogic.com:8080/#/c/34882/		av-restricted/platform/vendor/AmFFmpegAdapter




android O-mr1
http://scgit.amlogic.com:8080/#/c/38520/
http://scgit.amlogic.com:8080/#/c/38247/
http://scgit.amlogic.com:8080/#/c/38244/
http://scgit.amlogic.com:8080/#/c/38519/
源码：
http://scgit.amlogic.com:8080/#/c/38484/
http://scgit.amlogic.com:8080/#/c/38553/


0112
  0115
  0118
  0122
  0129
* 0209
  1222
  1227
  mediaext
  mediaext3
  o_dev
  
  
  cp: cannot stat 鈥榦ut/target/product/p212/obj/KERNEL_OBJ/drivers/usb/dwc3/dwc3.ko鈥 No such file or directory
cp: cannot stat 鈥榦ut/target/product/p212/obj/KERNEL_OBJ/drivers/amlogic/usb/dwc_otg/310/dwc_otg.ko鈥 No such file or directory


out/target/product/p212/obj/lib/libamffmpeg.so.toc
build out/target/product/p212/obj_arm/SHARED_LIBRARIES/libamffmpeg_intermediates/libamffmpeg.so.toc



20180226 9:10-

Bug 160710 - {Dolby Vision}平台连接任意DV电视，在DV模式下循环播放个别认证片源，概率出现绿屏现象。20%左右，无需对比

这两个是dv的
Bug 160699 - {AV}本地MoviePlayer播放部分Dolby Lab官方认证视频文件，播放中途会自动退出，无法正常播放。100%复现，对比LG电视播放正常。
[Bug 160332] [Foxconn-CCC]Dolby Vision 2.4 Certification视频会卡住或者出现马塞克

煲机的3个
Bug 158593 - [鹏博士-S905X-客户反馈-System]:轮播808频道进行煲机老化一晚，第二天会画面卡住，概率：50%
Bug 158171 - [天午-S905X-客户反馈-Video]:4K265煲机退出播放
Bug 159163 - [乐视-S905X-客户反馈-Video]：播放本地4K视频出现画面卡住的现象，概率：高

logcat | grep -v AM_DEBUG

/sys/module/amvdec_h265/parameters/nal_skip_policy
echo 3 > /sys/module/amvdec_h265/parameters/nal_skip_policy

[2018-02-25 06:40:29] 01-02 21:34:19.021 E/ion     ( 7432): ioctl c0204900 failed with code -1: No such device
[2018-02-25 06:40:29] 01-02 21:34:19.021 E/ion     ( 7432): ioctl c0204900 failed with code -1: Invalid argument
[2018-02-25 06:40:29] 01-02 21:34:19.021 D/gralloc ( 7432): (-22) Failed to alloc ion cma mem, alloc from system ion buffer.
author:aml.sh multi-media team

In file included from hardware/amlogic/omx/ComponentPeers/libOmxAudio/AmlogicAudioFFMPEGDecoder.cpp:24:
In file included from hardware/amlogic/omx/ComponentPeers/libOmxAudio/../../libOmxBase/AmlogicPeer.h:29:
In file included from hardware/amlogic/omx/ComponentPeers/libOmxAudio/../../libOmxBase/AmlogicPeerBufferWrapper.h:21:
hardware/amlogic/omx/ComponentPeers/libOmxAudio/../../include/omx_framework/BufferWrapper.h:21:10: fatal error: 'system/window.h' file not found
#include <system/window.h>
./frameworks/native/libs/nativewindow/include/system/window.h

weekly report
Bug 158367 - {CVT客户反馈}AMLT960X-2082 多媒体通道下，播放任意歌曲，info信息中比特率显示为unknown
	--年前已经解了，27号被reopen了，原因还未追踪
Bug 159765 - {AV} S905X 8.0 播放H.265 MKV黑屏，seek或者resume play后画面黑屏，声音正常 概率：100％
	--目前还有一个流异常，需添加特殊处理

煲机的3个仍在分析中,不好复现或者log还不完全，已提供debug的patch
Bug 158593 - [鹏博士-S905X-客户反馈-System]:轮播808频道进行煲机老化一晚，第二天会画面卡住，概率：50%
Bug 158171 - [天午-S905X-客户反馈-Video]:4K265煲机退出播放
Bug 159163 - [乐视-S905X-客户反馈-Video]：播放本地4K视频出现画面卡住的现象，概率：高

gl2a DV功能支持

扫描添加音频bitrate的识别 http://scgit.amlogic.com:8080/38522
amnuplayer设置输入buffer size，http://scgit.amlogic.com:8080/39801
上面两个的提交的so http://scgit.amlogic.com:8080/39868


http://scgit.amlogic.com:8080/39809
http://scgit.amlogic.com:8080/39870

http://scgit.amlogic.com:8080/40002 有些hevc mkv没有keyframe index，不能seek，采用与libplayer相同的方法
http://scgit.amlogic.com:8080/39996 有些的流的extradata（放的是nals）不符合android支持的format，转换成android支持的
http://scgit.amlogic.com:8080/40008


20180305 9；20-
160408 {CVT客户反馈}AMLT960X-2311 升级后，进入多媒体通道下，然后播放某视频，出现视频黑了20s才出画面的情况
160929 {CVT客户反馈}AMLT960X-2377 多媒体通道下，播放某视频3s左右，然后按退出键退出播放，再次点击播放，发现视频一直在加载不会播放
161276 {CVT客户反馈}AMLT960X-2378 多媒体通道下，播放MP3歌曲，提示不支持，出问题前执行的是AMLT960X-2377操作
160403 {CVT客户反馈}AMLT960X-2264 多媒体通道下，播放某视频，然后一直按右键，发现一直卡在某个地方不会继续播

上周：
Bug 159765 - {AV} S905X 8.0 播放H.265 MKV黑屏，seek或者resume play后画面黑屏，声音正常 概率：100％ 对比：S905X 7.1也存在
	---另一个异常流的处理已添加
Bug 158593 - [鹏博士-S905X-客户反馈-System]:轮播808频道进行煲机老化一晚，第二天会画面卡住，概率：50%
	---新添加的patch已不能复现
Bug 160699 - {AV}本地MoviePlayer播放部分Dolby Lab官方认证视频文件，播放中途会自动退出，无法正常播放。100%复现，对比LG电视播放正常
	---已解决，还需要在amnuplayer端添加设置video 输入buffer size的初始化设置
Bug 158367 - {CVT客户反馈}AMLT960X-2082 多媒体通道下，播放任意歌曲，info信息中比特率显示为unknown
	---完善个别audio流没有检测出bitrate的问题

Bug 159163 - [乐视-S905X-客户反馈-Video]：播放本地4K视频出现画面卡住的现象，概率：高
	---已更新debug patch，需要进一步分析
Bug 158171 - [天午-S905X-客户反馈-Video]:4K265煲机退出播放
	---已提供最新的debug patch
Bug 160332 - [Foxconn-CCC]Dolby Vision 2.4 Certification视频会卡住或者出现马塞克
	---辉哥说是流的LCU有丢失，等待dolby lab的反馈
	
本周：
	cvt的下面几个处理
		160408 {CVT客户反馈}AMLT960X-2311 升级后，进入多媒体通道下，然后播放某视频，出现视频黑了20s才出画面的情况
		160929 {CVT客户反馈}AMLT960X-2377 多媒体通道下，播放某视频3s左右，然后按退出键退出播放，再次点击播放，发现视频一直在加载不会播放
		161276 {CVT客户反馈}AMLT960X-2378 多媒体通道下，播放MP3歌曲，提示不支持，出问题前执行的是AMLT960X-2377操作
	上周未完成的问题
	公版8.1煲机flow


while [ true ];do procrank|grep media; done &


setprop libc.debug.malloc 1
setprop libc.debug.malloc.options   backtrace
setprop libc.debug.malloc.program  mediaserver
$dumpsys media.player -m > dump2
$diff dump1 dump2 > diff
$./addr2func.py --root-dir=<AOSP_dir> --maps-file=maps --product=<product_name_of_your_build> diff > mem_trace

1. 8.0上的没有内存问题，extractor创建在mediaserver中，会很大，便退出会释放
2. 7.1上使用non-ffmpeg extractor，不会很大，退出会释放一些，看不出是否有有问题，因为media.extractor不大


1. 7.1上audio和video各申请一个MediaBuffer，内存问题不太可能是MediaBuffer引起的。
2. 7.1上300Mbps的视频，由于解码比较慢，导致一直在video late，缓存在ffmpegextractor中的视频一直在累加。统计累积的缓存大小，基本与media.extractor增加的内存相符，二者的变化趋势也是相同的
3. 7.1上退出播放后media.extractor内存没有恢复，但再次播放时，media.extractor内存并没有大之前的基础上累加，而是又从一个小值开始继续增加，应该不是内存泄漏
4. 8.0上是在mediaserver中创建的ffmpegextractor，退出播放后，mediaserver的内存会恢复
5. 7.1的ffmegextractor是在media.extractor service创建的，修改成和8.0一样创建在mediaserver，退出播放后，mediaserver的内存没有恢复
6. 7.1退出播放时，缓存在ffmpegextractor中的视频packets，一个个free或者不free，media.extractor的内存都不恢复，这个问题比较奇怪



am start -n com.android.gallery3d/com.android.gallery3d.app.MovieActivity http://10.18.11.251/tv_qatest/chromecast_hw_test/other/vp9/%5b4KVP9_60.000fps_15.5Mbps%5dWetek-Astra-2m.webm

setprop edia.stagefright.cache-params "30720/51200/15"
setprop edia.stagefright.cache-params "61440/102400/15"

setprop media.stagefright.cache-params "65536/81920/5"
setprop media.stagefright.cache-params "12310/122880/5"


160408 {CVT客户反馈}AMLT960X-2311 升级后，进入多媒体通道下，然后播放某视频，出现视频黑了20s才出画面的情况
Bug 160403 - {CVT客户反馈}AMLT960X-2264 多媒体通道下，播放某视频，然后一直按右键，发现一直卡在某个地方不会继续播 
	-------media.extractor出现crash
Bug 161276 - {CVT客户反馈}AMLT960X-2378 多媒体通道下，播放MP3歌曲，提示不支持，出问题前执行的是AMLT960X-2377操作
Bug 160929 - {CVT客户反馈}AMLT960X-2377 多媒体通道下，播放某视频3s左右，然后按退出键退出播放，再次点击播放，发现视频一直在加载不会播放
	-------media.extractor出现out of memory，然后或者crash或者出现mediaplayer的报错
	
http://firmware.myamlogic.com/firmware/image/android/Android-N/BOX/openlinux/openlinux-0606/2018-03-12/p212-user-64-DRM-469/
http://firmware.myamlogic.com/firmware/image/android/Android-O/BOX/trunk/2018-03-12/p212-userdebug-64-AOSP-378/
http://firmware.myamlogic.com/firmware/image/android/Android-O/BOX/trunk/2018-03-10/p212-userdebug-64-AOSP-376/

wplay http://10.68.11.62:8800/4kvp9/4KVP9_60.000fps_15.5Mbps]Wetek-Astra-2m.webm



上周
Bug 160408 - {CVT客户反馈}AMLT960X-2311 升级后，进入多媒体通道下，然后播放某视频，出现视频黑了20s才出画面的情况
Bug 160403 - {CVT客户反馈}AMLT960X-2264 多媒体通道下，播放某视频，然后一直按右键，发现一直卡在某个地方不会继续播 
Bug 161276 - {CVT客户反馈}AMLT960X-2378 多媒体通道下，播放MP3歌曲，提示不支持，出问题前执行的是AMLT960X-2377操作
Bug 160929 - {CVT客户反馈}AMLT960X-2377 多媒体通道下，播放某视频3s左右，然后按退出键退出播放，再次点击播放，发现视频一直在加载不会播放
	---jemalloc的缓存机制导致的内存问题，相关的修改方法已提供，目前还没有再复现问题

Bug 158171 - [天午-S905X-客户反馈-Video]:4K265煲机退出播放
	---可能是之前处理异常流引入的线程竞争，已提供最新的debug patch

本周：
Bug 161238 - {AV}平台播放大部分Dolby Vision相关测试片源，视频正常播放中概率出现画面卡住，之后未响应的情况。20%左右，对比7.1正常
Bug 154690 - {AV} Android 8.0 播放HTTP 4KVP9视频流，画面卡顿，不流畅 概率：100％ 对比：S905X 7.1正常 (edit)
项目及公版上煲机问题

bugzila上与QA描述不是同一个问题
1.bug上描述的seek卡死（放开右键不会继续播放），现在测到的是连续seek不成功（seek的时间太短，感觉没有seek成功，放开右键会继续播放）
2.造成上面感觉seek成功的原因是，这个流的I帧间隔太长，若向前（播放方向）seek时间太短，seek查找一定量帧后找不到I帧，会向后找I帧，所以从现象上就感觉是没有seek成功
3.yunmin的建议是，连续按SEEK,就上面UI进度条动,等不SEEK了,才真正设下来SEEK位置.如果改右键SEEK值,有些片源I帧间隔小,就会跳过很多,SEEK精度又不够了

omxpts/apts/vpts/pcr
cat /sys/module/amvideo/parameters/omx_pts && cat /sys/class/tsync/pts_audio && cat /sys/class/tsync/pts_video && cat /sys/class/tsync/pts_pcrscr

/bin/hw/android.hardware.drm@1.0-service.widevine &

setprop media.omx.log_levels 255
while true; do sleep 0.02; cat  /sys/class/tsync/mode;cat /sys/class/tsync/pts_audio && cat /sys/class/tsync/pts_video && cat /sys/class/tsync/pts_pcrscr; done &

echo 0x10 > /sys/module/amvdec_vp9/parameters/debug   //VP9_DEBUG_OUT_PTS
echo 1 > /sys/class/tsync/debug_video_pts && echo 1 > /sys/class/tsync/debug_pts_checkin
echo 1 > /sys/class/tsync/debug_video_pts && echo 1 > /sys/class/tsync/debug_pts_checkout

echo 1 > /sys/class/tsync/debug_audio_pts && echo 1 > /sys/class/tsync/debug_pts_checkin
echo 1 > /sys/class/tsync/debug_audio_pts && echo 1 > /sys/class/tsync/debug_pts_checkout

ro.nrdp.validation=ninja_5.0

/mnt/fileroot/shuanglong.wang/o-amlogic-openlinux/out/target/product/p212/vendor/lib/hw/audio.primary.amlogic.so

20180319 9:40-
上周：
Bug 160403 - {CVT客户反馈}AMLT960X-2264 多媒体通道下，播放某视频，然后一直按右键，发现一直卡在某个地方不会继续播
	--特殊流，I帧间隔长，个别流先不修改seek机制
Bug 161008 - {AV}需求：需要支持播放AVS2.0流
	--ffmpeg识别avs2的ts格式，其它未做
Bug 161942 - [Ref#161895-客户反馈-NTS]：部分case播放视频音画不同步。概率：100%，对比：无需对比	
	--audio的pts gap过重新reset下pcr
Bug 161944 - [Ref#161887-P252-客户反馈-NTS]:PLAY-101-TC8,Swim to half the movie failed with error: "Expected time needs to be between 734 and 754 but got 48464.783"
	--获取vpts error的异常处理

本周：
nts问题：
	Bug 162413 - [P252-客户反馈-NTS]：NTS测试HDR-001-TC3 视频无法播放出来，声音和OSD显示正常，100%
	Bug 162414 - [P252-客户反馈-NTS]：NTS测试PLAY-103-TC5项vp9视频播放，音频先出来视频后出来，大概能延迟1s，100%
煲机问题


setprop media.omx.display_mode 1  //强制走video层
cat /sys/class/vfm/map	
echo dump decoder > /sys/class/vfm/map
cat /sys/class/video/disable_video

echo 0 > /sys/class/tsync/enable

echo 1  > /sys/class/graphics/fb0/osd_display_debug
echo 1 > /sys/class/graphics/fb0/blank


1.查看videolayer的状态
cat /sys/class/video/disable_video
cat /sys/class/video/vframe_states

echo 1 > /sys/class/video/disable_video
echo 2 > /sys/class/video/disable_video
echo 0 > /sys/class/video/disable_video
echo d  >  /sys/class/graphics/fb0/debug 

2.查看vfm的链路状态
cat /sys/class/vfm/map
echo 0 > /sys/class/tsync/enable
echo 1 > /sys/class/video/slowsync_repeat_enable
echo 0x20000> /sys/module/amvideo/parameters/debug_flag
cat /sys/module/amvideo/parameters/underflow
cat /sys/class/video/freerun_mode
echo 1 > /sys/class/video/freerun_mode

echo d  >  /sys/class/graphics/fb0/debug 


3.关掉osd看是否出图像
echo 1  > /sys/class/graphics/fb0/osd_display_debug;echo 1 > /sys/class/graphics/fb0/blank
echo 1 > /sys/class/graphics/fb0/blank

4.osd
echo 0xd0107400 128 > /sys/kernel/debug/aml_reg/dump
cat /sys/kernel/debug/aml_reg/dump > ./regs_from_1d00.regs
echo 0xd0107600 128 > /sys/kernel/debug/aml_reg/dump
cat /sys/kernel/debug/aml_reg/dump >> ./regs_from_1d00.regs
echo 0xd0106B80 32 > /sys/kernel/debug/aml_reg/dump
cat /sys/kernel/debug/aml_reg/dump > ./regs_from_1ae0.regs
echo 0xd0106940 96 > /sys/kernel/debug/aml_reg/dump
cat /sys/kernel/debug/aml_reg/dump > ./regs_from_1a50.regs
另外,黑屏的时候, 读一下1a06和1a07
echo rv 1a06 > /sys/class/amvecm/reg


Total 12 (delta 7), reused 0 (delta 0)
remote: Resolving deltas: 100% (7/7)
remote: Processing changes: new: 2, updated: 2, refs: 4, done    
remote: Missing issue-id in commit message
remote: Commit c008a0de52f79c4d2664d8ddc957b228b2e3ccdb not associated to any issue
remote: 
remote: Hint: insert one or more issue-id anywhere in the commit message.
remote:       Issue-ids are strings matching [pP][dD]\s?[#-]\s?([0-9]{5,6})
remote:       and are pointing to existing tickets on its-bugzilla Issue-Tracker
remote: (W) 4db326a: no files changed, message updated
remote: 
remote: New Changes:
remote:   http://scgit.amlogic.com:8080/41222 PD#161966 libOmxAudio: add audio/ffmpeg decoder api[3/5]                     ...
remote:   http://scgit.amlogic.com:8080/41223 fix android8.0 compile error
remote: 
remote: 
remote: Updated Changes:
remote:   http://scgit.amlogic.com:8080/41216 PD#160811 update libOmxAudio         1.fix audio stuck problem         2.add ...
remote:   http://scgit.amlogic.com:8080/41220 omx: add get AMSTREAM_GET_VPTS error handle
remote: 
To ssh://shuanglong.wang@scgit.amlogic.com:29418/av-restricted/platform/hardware/amlogic/omx
 * [new branch]      HEAD -> refs/for/refs/heads/o-amlogic-openlinux-20171215


 
 commit 4e8e78b6478f86a19a4d293051decbca7711f7f2
Author: qi.yuan <qi.yuan@amlogic.com>
Date:   Thu Feb 8 21:35:52 2018 +0800

    PD#159902 1.add libHwAudio_dcvdec.so for OMX audio dd dd+ decoder and passthrough
              2.[libOmxAudio] fix the pcm out noise
              3.[libOmxAudio] fix 8ch dd+ passthrough
    
    Change-Id: I20a36c4630f9b6a13a946ef8947c0abf16a93cee

HDR	
 cat /sys/class/amvecm/hdr_dbg
 cat /sys/module/am_vecm/parameters/hdr_mode
 cat /sys/class/amhdmitx/amhdmitx0/hdr_cap
 cat /sys/class/switch/hdmi_hdr
 
 
目前的情况：NTS测试HDR-001-TC3 视频无法播放出来，声音和OSD显示正常，解码有输了，video_layer没有disable,osd没有遮挡


http://scgit.amlogic.com:8080/41222
http://scgit.amlogic.com:8080/41223
http://scgit.amlogic.com:8080/41216
http://scgit.amlogic.com:8080/41220
http://scgit.amlogic.com:8080/41225


echo 0x43> /sys/module/amvideo/parameters/skip_policy

1.RDMA
cat /sys/module/rdma/parameters/enable
echo 1 > /sys/module/rdma/parameters/enable

2.
cat /sys/module/di/parameters/di_vscale_skip_count_real &&
cat /sys/module/di/parameters/di_vscale_skip_count &&
cat /sys/module/di/parameters/di_vscale_skip_enable

3.
t962x_r311:/ # cat /sys/class/vfm/map
[00]  default { decoder(0) ppmgr(0) deinterlace(0) amvideo}
[01]  default_amlvideo2 { vdin1(0) amlvideo2.1}
[02]  dvblpath { dvbldec(0) amvideo}
[03]  dvelpath { dveldec(0) dvel}
[04]  dvhdmiin { dv_vdin(0) amvideo}
[05]  tvpath { vdin0(0) amlvideo2.0(0) ppmgr(0) deinterlace(0) amvideo}
[06]  vdec-map-0 { vdec.h264.00(1) amlvideo(1) deinterlace(1) amvideo}

cat /sys/module/di/parameters/bypass_state
echo 0/1 > /sys/module/di/parameters/nr2_en
echo state > /sys/class/deinterlace/di0/debug
cat /sys/module/di/parameters/same_field_bot_count &&
cat /sys/module/di/parameters/same_field_top_count

4.
cat /sys/class/video/video_state

5.
echo 0x43 > /sys/module/amvideo/parameters/skip_policy
echo 0x43 > /sys/module/amvideo/parameters/skip_policy



while true; do cat /sys/class/video/axis; done &

main264
0 0 1919 1079
0 0 1919 1079
99 56 1911 1075             echo "99 56 1911 1075" > /sys/class/video/axis
812 462 1852 1047			echo "812 462 1852 1047" > /sys/class/video/axis
1326 755 1810 1027			echo "1326 755 1810 1027" > /sys/class/video/axis
1366 777 1806 1024			echo "1366 777 1806 1024" > /sys/class/video/axis
1367 778 1807 1025
1367 778 1807 1025

0 0 1919 1079
0 0 1919 1079
23 13 1917 1078				echo "23 13 1917 1078" > /sys/class/video/axis
412 234 1885 1063			echo "412 234 1885 1063" > /sys/class/video/axis
1077 613 1831 1036			echo "1077 613 1831 1036" > /sys/class/video/axis
1309 745 1812 1027			echo "1309 745 1812 1027" > /sys/class/video/axis
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839			echo "1372 783 1472 839" > /sys/class/video/axis    花屏
1367 778 1807 1025
1367 778 1807 1025

0 0 1919 1079
5 3 1919 1079
176 100 1905 1072			echo "176 100 1905 1072" > /sys/class/video/axis
818 466 1852 1047			echo "818 466 1852 1047" > /sys/class/video/axis
1133 645 1826 1034			echo "1133 645 1826 1034" > /sys/class/video/axis
1286 732 1814 1028			echo "1286 732 1814 1028" > /sys/class/video/axis
1340 763 1809 1026			echo "1340 763 1809 1026" > /sys/class/video/axis
1366 777 1807 1025			echo "1366 777 1807 1025" > /sys/class/video/axis
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839			echo "1372 783 1472 839" > /sys/class/video/axis	花屏
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025


0 0 1919 1079
5 3 1919 1079
176 100 1905 1072
818 466 1852 1047
1133 645 1826 1034
1286 732 1814 1028
1340 763 1809 1026
1366 777 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025


0 0 1919 1079
0 0 1919 1079
21 12 1917 1078				echo "21 12 1917 1078" > /sys/class/video/axis
176 100 1905 1072			echo "176 100 1905 1072" > /sys/class/video/axis
693 394 1862 1052			echo "693 394 1862 1052" > /sys/class/video/axis
818 466 1852 1047			echo "818 466 1852 1047" > /sys/class/video/axis
1133 645 1826 1034			echo "1133 645 1826 1034" > /sys/class/video/axis
1225 697 1819 1031			echo "1225 697 1819 1031" > /sys/class/video/axis
1340 763 1809 1026			echo "1340 763 1809 1026" > /sys/class/video/axis
1366 777 1807 1025			echo "1366 777 1807 1025" > /sys/class/video/axis
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839			echo "1372 783 1472 839" > /sys/class/video/axis
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025


4k265_lg
0 0 1919 1079
0 0 1919 1079
0 0 1919 1079
0 0 1919 1079
17 10 1918 1078			echo "17 10 1918 1078" > /sys/class/video/axis
43 25 1915 1077			echo "43 25 1915 1077" > /sys/class/video/axis
1062 604 1832 1037		echo "1062 604 1832 1037" > /sys/class/video/axis
1337 761 1809 1026		echo "1337 761 1809 1026" > /sys/class/video/axis
1365 777 1807 1025		echo "1367 778 1807 1025" > /sys/class/video/axis
1367 778 1807 1025		echo "1367 778 1807 1025" > /sys/class/video/axis
1367 778 1807 1025
1372 783 1472 839
1372 783 1472 839		echo "1372 783 1472 839" > /sys/class/video/axis
1367 778 1807 1025
1367 778 1807 1025		echo "1367 778 1807 1025" > /sys/class/video/axis
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025

0 0 1919 1079
0 0 1919 1079
52 30 1915 1077
412 234 1885 1063
693 394 1862 1052
693 394 1862 1052
818 466 1852 1047
1225 697 1819 1031
1286 732 1814 1028
1352 769 1808 1026
1366 777 1807 1025
1367 778 1807 1025
1372 783 1472 839
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 102


[4k264——23.976fps——10bit]
0 0 1919 1079
0 0 1919 1079
0 0 1919 1079
103 58 1911 1075
412 234 1885 1063
1077 613 1831 1036
1184 674 1822 1032
1309 745 1793 1017
1367 778 1807 1025
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025


0 0 1919 1079
0 0 1919 1079
5 3 1919 1079
99 56 1911 1075
280 159 1896 1068
916 522 1844 1043
1286 732 1814 1028
1340 763 1809 1026
1366 777 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025

[4k265_16.9m 589.994 workcup]
0 0 1919 1079
0 0 1919 1079
0 0 1919 1079
5 3 1919 1079
103 58 1911 1075
693 394 1862 1052
1077 613 1831 1036
1133 645 1826 1034
1358 773 1808 1025
1366 777 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839
1372 783 1472 839
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025

0 0 1919 1079
0 0 1919 1079
0 0 1919 1079
23 13 1917 1078
693 394 1862 1052
1286 732 1814 1028
1340 763 1809 1026
1367 778 1807 1025
1367 778 1807 1025
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025

[4kvp9_23.976_26.5
0 0 1919 1079
0 0 1919 1079
21 12 1917 1078
280 159 1896 1068
812 462 1852 1047
916 522 1844 1043
1286 732 1814 1028
1366 777 1807 1025
1367 778 1807 1025
1372 783 1472 839
1372 783 1472 839
1367 778 1807 1025
1367 778 1807 1025
1367 778 1807 1025



ftp://firmware.reference:Druf_T3t@ftp-china.amlogic.com/mbox

北京市西城区金融街23号平安大厦9层理赔柜面尚晓雨


source $android_top/device/amlogic/common/quick_build_kernel.sh build-modules
modified:   drivers/stream_input/amports/amstream.c
        modified:   drivers/stream_input/parser/esparser.c

		
echo rv 1a50 > /sys/class/amvecm/reg 
[ 1738.943698@2] VPU[0x1a50]=0x188a0043

1)kernel打印underflow情况
while true;do cat /sys/module/amvideo/parameters/underflow;sleep 1;done &
echo 3 > /sys/module/amvideo/parameters/video_dbg_vf
echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
echo 0 > /sys/module/amvideo/parameters/debug_flag
echo 0x20000 > /sys/module/amvideo/parameres/debug_flag   //per frame
echo 1 > /sys/class/video/slowsync_repeat_enable
echo 1 > /sys/class/video/slowsync_repeat_enable
/sys/module/amvideo/parameters/omx_pts_interval_lower
/sys/module/amvideo/parameters/omx_pts_interval_upper

1.视频（1080p 264）卡的时候，音频不卡
2.omx的inputs与outpts没有异常
3.omx的打印有大量的下面的dropped frame pts,reset pcr
	03-30 09:47:38.594  2755  3126 D AmlogicVideoDecoderAwesome: dropped frame pts=1007589000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=110
3.underflow时打印vfm链路（decoder amlvideo amvideo）的情况以及pcr的调整的打印，但统计omx的in和out的平均个数，应该不是解码慢
	03-30 09:50:25.728     0     0 I Kernel  : <6>[  684.172563@0] decoder_pool_size=64
	03-30 09:50:25.729     0     0 I Kernel  : <6>[  684.172569@0] decoder buf_free_num=63
	03-30 09:50:25.729     0     0 I Kernel  : <6>[  684.172572@0] decoder buf_avail_num=0
	03-30 09:50:25.730     0     0 I Kernel  : <6>[  684.172575@0] amlvideo_pool_size=16
	03-30 09:50:25.730     0     0 I Kernel  : <6>[  684.172577@0] amlvideo buf_free_num=16
	03-30 09:50:25.730     0     0 I Kernel  : <6>[  684.172579@0] amlvideo buf_avail_num=0
	03-30 09:51:29.475     0     0 I Kernel  : <6>[  747.922561@0] system_time=2250, omx_pts=0, diff=2250
	03-30 09:51:29.592     0     0 I Kernel  : <6>[  748.039222@0] system_time=2250, omx_pts=0, diff=2250
	03-30 09:51:29.609     0     0 I Kernel  : <6>[  748.055893@0] system_time=2250, omx_pts=0, diff=2250
	03-30 09:51:29.660     0     0 I Kernel  : <6>[  748.105889@0] system_time=2250, omx_pts=0, diff=2250
	03-30 09:51:29.710     0     0 I Kernel  : <6>[  748.155898@0] system_time=2250, omx_pts=0, diff=2250
4.增加omx输出buffer个数，从6->8,没有效果
5.下面的log，第一个大量的dropped frame pts是在09:46:21，inpts和outpts在09:46:16和09:46:21之间是断的，没有了输入输出，log像是暂停了，09:46:21再次播放时就出现大量的dropped frame pts
这个原因不知道，log里dropped frame pts基本都是这样情况，具体原因还不知道
2071:03-30 09:46:21.648  2755  2812 D AmlogicVideoDecoderAwesome: dropped frame pts=1008132000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=123
2078:03-30 09:46:21.652  2755  2812 D AmlogicVideoDecoderAwesome: dropped frame pts=1008173000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=124
2083:03-30 09:46:21.653  2755  2812 D AmlogicVideoDecoderAwesome: dropped frame pts=1008215000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=125
2088:03-30 09:46:21.656  2755  2812 D AmlogicVideoDecoderAwesome: dropped frame pts=1008257000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=126
2113:03-30 09:46:21.687  2755  2812 D AmlogicVideoDecoderAwesome: dropped frame pts=1008298000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=127
2117:03-30 09:46:21.689  2755  2812 D AmlogicVideoDecoderAwesome: dropped frame pts=1008340000, mInputTimeStampChanged=0, need_reset_omx_pts=1, frame_num=128

1904:03-30 09:46:15.914  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1007965000,	nFilledLen=6963, bufferHdr.pBuffer=ecb0f0b0
1913:03-30 09:46:15.944  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008132000,	nFilledLen=8228, bufferHdr.pBuffer=ece98f50
1923:03-30 09:46:15.994  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008048000,	nFilledLen=6734, bufferHdr.pBuffer=ecb0f0b0
1934:03-30 09:46:16.027  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008090000,	nFilledLen=6634, bufferHdr.pBuffer=ece98f50
1948:03-30 09:46:16.082  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008257000,	nFilledLen=7339, bufferHdr.pBuffer=ecb0f0b0
2035:03-30 09:46:21.428  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008173000,	nFilledLen=6295, bufferHdr.pBuffer=ece98f50
2042:03-30 09:46:21.437  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008215000,	nFilledLen=6429, bufferHdr.pBuffer=ecb0f0b0
2046:03-30 09:46:21.441  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008382000,	nFilledLen=7005, bufferHdr.pBuffer=ece98f50
2051:03-30 09:46:21.450  2755  6024 D AmlogicVideoDecoderAwesome: In PTS 1008298000,	nFilledLen=5940, bufferHdr.pBuffer=ecb0f0b0

1906:03-30 09:46:15.915  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1007881000..vf.fd=0, mOutBufferNo=136, frame_num=117
1915:03-30 09:46:15.948  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1007923000..vf.fd=0, mOutBufferNo=137, frame_num=118
1925:03-30 09:46:16.002  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1007965000..vf.fd=0, mOutBufferNo=138, frame_num=119
1926:03-30 09:46:16.003  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1008007000..vf.fd=0, mOutBufferNo=139, frame_num=120
1950:03-30 09:46:16.086  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1008048000..vf.fd=0, mOutBufferNo=140, frame_num=121
2048:03-30 09:46:21.446  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1008090000..vf.fd=0, mOutBufferNo=141, frame_num=122
2050:03-30 09:46:21.448  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1008132000..vf.fd=0, mOutBufferNo=142, frame_num=123
2053:03-30 09:46:21.452  2755  6014 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1008173000..vf.fd=0, mOutBufferNo=143, frame_num=124


ce3(1080p)测试项出现卡顿不同步的现象，卡顿的时候音频是正常的，且打印大量的AmlogicVideoDecoderAwesome: dropped frame pts和调整pcr system_time=90693511, omx_pts=90709291, diff=-15780这样的打印，看dropped frame pts的时间点，像是暂停再播放时现大量的dropped frame，


grep -rnI "Out PTS" all-logcat-ce3-short-1 > 3_out.log
grep -rnI "In PTS" all-logcat-ce3-short-1 > 3_input.log
grep -rnI "dropped frame pts" all-logcat-ce3-short-1 > 3_drop.log

echo 3 > /sys/module/aml_vfm/parameters/vfm_trace_enable
echo 100 > /sys/module/aml_vfm/parameters/vfm_trace_num
echo 0 > /proc/sys/kernel/printk
dmesg -c > /dev/null
dmesg

setprop media.omx.log_levels 255
echo 0 > /proc/sys/kernel/printk
echo 3 > /sys/module/amvideo/parameters/video_dbg_vf
while true;do echo dump decoder > /sys/class/vfm/map; echo dump amlvideo > /sys/class/vfm/map; sleep 0.5;done &

setprop   debug.stagefright.omx-debug 5

while true;do dumpsys meminfo; sleep 1;done &


setprop media.omx.log_levels 255
echo 0 > /proc/sys/kernel/printk
echo 3 > /sys/module/amvideo/parameters/video_dbg_vf

2)
修改omx decoder输出个数
编译的有so
setprop media.omx.out_buffer2 8

amlvideo  这边消耗是受上层apk 同步控制的
apk 同步完 提交sf 显示 hwc 那边设置omx 到amvideo 更新系统时间

Bug 155373 - [P355-客户反馈-Video]：本地播放dropframe.mp4片源严重掉帧，概率：必现 (edit) 


yuwentengbo 62服务器
3Cxq1Xa


1 secm 3m->1.6

2 dpb
static u32 dpb_size_adj = 6;
DPB buffer大小
cat /sys/module/amvdec_h264/parameters/dpb_size_adj 6
echo 4 > /sys/module/amvdec_h264/parameters/dpb_size_adj
/sys/module/amvdec_mh264/parameters/h264_debug_flag

3 setprop   debug.stagefright.omx-debug 5
抓一段logcat的打印
grep -rnI "decrypt.*take" all-logcat-more-log-ce3-short-2 > 4_decrypt.log
sed -n 's/.*decrypt \(.*\)\]/\1/p' 4_decrypt.log > 4_decrypt_timeus.log
sed -n 's/.*decrypt.*take \(.*\) us.*/\1/p' 4_decrypt.log > 4_decrypt_taketime.log

grep -rnI "In PTS"  all-logcat-0042-101-tc5 > 5_input.log
grep -rnI "Out PTS" all-logcat-0042-101-tc5 > 5_out.log
grep -rnI "dropped frame pts" all-logcat-0042-101-tc5 > 5_drop.log

grep "queueInputBuffer@OMX.google"  all-logcat-3 > all-logcat-3_audio_queue.log
grep "queueSecureInputBuffer@OMX.amlogic" all-logcat-3 > all-logcat-3_video_queue.log
grep "dequeueOutputBuffer@OMX.google"  all-logcat-3 > all-logcat-3_audio_dequeue.log
grep "dequeueOutputBuffer@OMX.amlogic"  all-logcat-3 > all-logcat-3_video_dequeue.log

20180402 
1.换板子
2.北京想办法复现，保持完全一致的环境
3.
echo 6 > /sys/module/amvdec_mh264/parameters/reference_buf_margin
echo 8 > /sys/module/amvdec_mh264/parameters/reorder_dpb_size_margin
6->8 omx outbuffer 

04-01 00:41:40.849  2744  7486 D AmlogicVideoDecoderAwesome:   		  Out PTS: 1006630000..vf.fd=0, mOutBufferNo=106, frame_num=87
04-01 00:41:40.855  7064  7484 I MediaCodec: [dequeueOutputBuffer@OMX.amlogic.avc.decoder.awesome.secure] dequeue -1@systemtime 740246043 us
04-01 00:41:40.855  7064  7478 I MediaCodec: [kWhatDequeueOutputBuffer1@OMX.amlogic.avc.decoder.awesome.secure] timeus -1 @systemtime 740246174 us
04-01 00:41:40.855  7064  7478 I MediaCodec: [kWhatDequeueOutputBuffer2@OMX.amlogic.avc.decoder.awesome.secure] timeus:-1 @systemtime 740246245 us
04-01 00:41:40.855  7064  7478 I MediaCodec: [kWhatDequeueOutputBuffer3@OMX.amlogic.avc.decoder.awesome.secure] timeus:-1 @systemtime 740246301 us
04-01 00:41:40.855  7064  7478 I MediaCodec: [kWhatDequeueOutputBuffer4@OMX.amlogic.avc.decoder.awesome.secure] timeus:-1 @systemtime 740246344 us

04-01 00:41:41.073  7064  7484 I MediaCodec: [dequeueOutputBuffer@OMX.amlogic.avc.decoder.awesome.secure] timeUs:1006630000, dequeue take 218165 us


20180402 
audiotrack->gettime(), gettimestamp();....打印一下。

status_t MediaCodec::renderOutputBufferAndRelease(size_t index, int64_t timestampNs) 
status_t MediaCodec::renderOutputBufferAndRelease(size_t index)
status_t MediaCodec::releaseOutputBuffer(size_t index)

1. 小米8.0 nts vp9播放慢
	--vp9的triger引起video送数据慢、pcr置位、时序乱等问题，没有找到好的修改方法，目前修改为tunnel模式时，关闭trigger
2. 小米8.0 nts av卡顿不同步问题（tunnel 和non-tunnel切换）
	--tunnel mode播放，如果这时候有系统音混进来，需要更新系统音这路的时间戳，framework会根据这个算后面普通播放的时间戳
3. focc dv认证个别流黑屏无输出
	--mime里没有识别AV_CODEC_ID_DVVIDEO的处理，作MEDIA_MIMETYPE_VIDEO_HEVC处理，已提供patch，还没有提交上trunk
4. 播放个别HLG片源TravelXP_4K_HDR_HLG.ts，起播画面卡顿,播放中间歇性掉帧卡顿
	--之前的提交code已处理掉该问题，tv上已无此问题，box上需要确认下
	

	
这里总结下：vp9的trig会引起nts测试的两类测试问题
1）vp9播放视频比音频晚出来1s左右
2）vp9播放av不同步问题，差3s左右，是由于trig reset引起pcr、apts被置位，并发现VIDEO_STOP event，使时序错乱，导致av不同步

最新tengbo提供给小米的code是干掉了vp9 tunnel的trig功能，没有这个问题了，fixed
先在项目里支持此功能相关的omx源码
Change proposed: 'omx: close ，trig for vp9 tunnel mode' (av-restricted/platform/hardware/amlogic/omx o-amlogic-openlinux-20171215)
http://scgit.amlogic.com:8080/41751


1.腾讯播放器播放正片audio没有走MediaCodec，只有视频走了MediaCodec，播放有“突突突”的声音
2.libplayer也能复现问题，有类似“codec:[1103]reset apts:0xb9833b-->0xb957df”的log，但没有“突突突”的声音
	2.1) echo 0 > /sys/class/tsync/enable，关闭同步，还是会出现卡顿
	2.2) cat /sys/class/amstream/bufs 卡顿时没有下溢，audio和video的level都是ok的，只是video的space有点小
	2.3) 统计卡顿时每秒的frames，大概24帧率/秒，速度还可以，但也不排除瞬间变慢的可能性
	2.4）audio和video的pts问题，没有细看，可以追踪看下

	
假设某通道的音频信号是采样率为8kHz，位宽为16bit，20ms一帧，双通道，则一帧音频数据的大小为：
int size = 8000 x 16bit x 0.02s  x 2 = 5120 bit = 640 byte	

getDurationUsIfPlayedAtSampleRate(mNumFramesWritten) - t
t = getDurationUsIfPlayedAtSampleRate(numFramesPlayed) + nowUs - (ts.mTime.tv_sec * 1000000LL + ts.mTime.tv_nsec / 1000)
getDurationUsIfPlayedAtSampleRate(mNumFramesWritten) - (getDurationUsIfPlayedAtSampleRate(numFramesPlayed) + nowUs - (ts.mTime.tv_sec * 1000000LL + ts.mTime.tv_nsec / 1000))


cp: cannot stat 鈥榦ut/target/product/p212/obj/KERNEL_OBJ/drivers/usb/dwc3/dwc3.ko鈥 No such file or directory
cp: cannot stat 鈥榦ut/target/product/p212/obj/KERNEL_OBJ/drivers/amlogic/usb/dwc_otg/310/dwc_otg.ko鈥 No such file or directory

error: common/: branch amlogic-4.9-dev is published (but not merged) and is now 1 commits behind
error: vendor/amlogic/prebuilt/libmedia/: vendor/amlogic/prebuilt/libmedia checkout 8cc2992bd1cf76d9e9c6cadf0a21171b00474914 


20180410
echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
	 0x4000000

echo 180000 > /sys/module/amvideo/parameters/omx_pts_return_difference
echo 1 > /sys/class/video/slowsync_repeat_enable

#检查目录下磁盘空间
du . -d 1 -h -x


抓hdcp的情况
setprop media.wv.printhdcp 1

20180417 9:10
1.
Bug 164176 - Dolby Vision 認證: 播放No.531認證片源,一開始的畫面沒有顯示(0秒~1秒), 並且播放過程中有小閃爍 (edit) 
Bug 162413 - [P252-客户反馈-NTS]：NTS测试HDR-001-TC3 视频无法播放出来，声音和OSD显示正常，100%


#pengbang ca,ta的存储位置
ca 在verdor/lib
ta 在/verdor/lib/teetz

setprop   debug.stagefright.omx-debug 5
dumpsys SurfaceFlinger --latency "com.netflix.ninja/com.netflix.ninja.MainActivity"
8.0以下加大输出buffer数需要设置下面的属性
setprop media.omx.out_buffer2 8


sed -n 's/.*n.pts=\(.*\), scr.*/\1/p' kernel.log > npts.log
sed -n 's/.*scr = \(.*\), omxpts.*/\1/p' kernel.log > scr.log
sed -n 's/.*omxpts=\(.*\)/\1/p' kernel.log >omxpts.log
getsfrdpts logcat.log
grep "render____time" logcat.log > render.log

echo 0x20000 > /sys/module/amvideo/parameters/debug_flag
echo 0x420000 > /sys/module/amvideo/parameters/debug_flag


7.1:
	Widevine CDM version version: 	v4.1.0-android 
	OEMCrypto version:				V11
8.0:
	Widevine CDM version version: 	v5.1.0-android
	OEMCrypto version:				V13
	
	alias set_androidtop='export android_top='
	export android_top="/mnt/fileroot/shuanglong.wang/o-amlogic"
	
 modified:   frame_provider/decoder/utils/vdec.c
        modified:   frame_provider/decoder/utils/vdec.h
        modified:   stream_input/parser/esparser.c


am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80015468?source=99'

libOmxAudio.so   libdatachunkqueue_alt.so   libomx_timed_task_queue_alt.so  libOmxBase.so    libfpscalculator_alt.so    libomx_worker_peer_alt.so       libOmxCore.so    libomx_av_core_alt.so      libstagefrighthw.so             libOmxCoreSw.so  libomx_clock_utils_alt.so  libthreadworker_alt.so          libOmxVideo.so   libomx_framework_alt.so
8189es.ko            amvdec_mh264.ko   amvdec_vc1.ko      encoder.ko       8822bu.ko            amvdec_mjpeg.ko   amvdec_vp9.ko      firmware.ko      amvdec_avs.ko        amvdec_mmjpeg.ko  audio_data.ko      media_clock.ko   amvdec_h264.ko       amvdec_mmpeg4.ko  bcmdhd.ko          modules.dep      amvdec_h264_4k2k.ko  amvdec_mpeg12.ko  ddr_window_64.ko   stream_input.ko  amvdec_h264mvc.ko    amvdec_mpeg4.ko   decoder_common.ko  amvdec_h265.ko       amvdec_real.ko    dhd.ko

#decoder module
/common/include/linux/amlogic/media/utils
chmod a+x device/amlogic/common/quick_build_kernel.sh
export TOP=$PWD;
device/amlogic/common/quick_build_kernel.sh build-modules


show_nopowerdown
store_nopowerdown
int nopowerdown1;

echo 0x4000000 > /sys/module/amvideo/parameters/debug_flag
	 0x4000000
	 
	 
pr_info("[wsl] amports_gate_clk 0 nopowerdown=%d, ptsregval=%d\n", nopowerdown, READ_PARSER_REG(AUDIO_PTS));
			
pr_info("[wsl] amporte_init 0 nopowerdown=%d, ptsregval=%d\n",
            nopowerdown, READ_PARSER_REG(AUDIO_PTS));

一个是我们4.9 kernel本身的通过 APTS节点来动态纠正系统时间的通路在4.9上被#if 0掉了，这个不知道历史
另外一个是因为vp9 reset的关系，原来设置好的pcrscr的系统时间，在VIDEO_STOP的时候被清掉了，
导致正式的码流过来第二次 VIDEO_START触发的时候，认为系统没有设置系统时间，
从而设了一个比第一个video pts晚3秒的系统时间，又因为前一个动态纠正的机制失效的问题，导致video额外晚三秒才播出，而且无法恢复
在netflix上面的播放表现是开始播放的时候，声音已经出来了，但是video因为没有有效的vpts(还在等那个3秒到了才能把第一帧放出来），
UI上面显示就是转圈三秒后，video出来
这个改法有个隐患就是如果VIDEO_STOP不去清掉audio建立了系统时间的flag的话，下一次播放，如果VIDEO_START先来，
它辉认为当前的系统时间是有效的，就不去打开系统时间了
所以我前面加了个在设置enable的时候来清掉，这个假定是比较危险的

			
这个是利用vp9 reset前面小码流的特殊性
这个reset虽然没法避免vfm path建立的过程，但是有个特点就是前面用来reset的帧是不会去显示的
所以实际上前面reset的时候，是没有VIDEO_START event的
我们可以利用这个特性，所以我第二个改法是在video.c这边，如果前面没有发过VIDEO_START那unregister的时候也没必要去发VIDEO_STOP了，
这样等到正式码流过来的时候，原来的VIDEO_START/STOP的逻辑还能存在

error: unpack failed: error Missing tree 898323312ab622fda3ee2b45de70e15b509b4ba6
fatal: Unpack error, check server log
To ssh://shuanglong.wang@scgit.amlogic.com:29418/kernel/common
 ! [remote rejected] HEAD -> refs/for/refs/heads/amlogic-4.9-dev (n/a (unpacker error))
error: failed to push some refs to 'ssh://shuanglong.wang@scgit.amlogic.com:29418/kernel/common'

echo 0x4000002 > /sys/module/amvideo/parameters/debug_flag


mega
ssh mega.wu@114.34.7.135
4Mgao$$$
ssh mega.wu@droid01-tw
4Mgao$$$
/mnt/fileroot2/mega.wu/Foxconn/CCC/myam_n_openlinux-sdk/
lunch q201-userdebug-64

dv一帧一帧的显示
echo 0x4000002 > /sys/module/amvideo/parameters/debug_flag
echo 0x80 > /sys/module/am_vecm/parameters/debug_dolby
echo 0x4 > /sys/module/am_vecm/parameters/dolby_vision_flags

echo r 1d26 > /sys/class/graphics/fb0/debug
echo 0 > /sys/class/video/disable_video
echo r 1d26 > /sys/class/graphics/fb0/debug
07fc10b0

1ae0和1d26
echo 0 > /sys/module/amvideo/parameters/debug_flag
echo rv 1ae0 > /sys/class/amvecm/reg


echo 0x4 > /sys/module/am_vecm/parameters/dolby_vision_flags;
echo 0x4000002 > /sys/module/amvideo/parameters/debug_flag;
sleep 1;
echo 0 > /sys/module/amvideo/parameters/debug_flag;
echo r 1d26 > /sys/class/graphics/fb0/debug;


echo 0x4 > /sys/module/am_vecm/parameters/dolby_vision_flags

echo r 1d26 > /sys/class/graphics/fb0/debug

[ 1241.732679@5] VPU[0x1ae0]=0x00001700
[ 1251.093665@6] fb: reg[0x1d26]: 0x07fc54b0

[   63.045074@7] VPU[0x1ae0]=0x00001700
[   69.257165@7] fb: reg[0x1d26]: 0x000054b0

Bug 147365 - {Android TV}widevine L1不工作，导致playmovies&TV、netflix、Cast等涉及到L1加密的应用无法使用。100%，对比：不需要
setprop media.wv.dbglevel 0x87

上周
1. Dolby Vision 認證: 播放No.531認證片源,一開始的畫面沒有顯示(0秒~1秒), 並且播放過程中有小閃爍
	--流特殊，el的dts与bl的dts不对应，按照相同的dts merge bl和el导致解码器丢了48 frames，需要验证patch对其它的dv的影响，有风险
2.Bug 163540 - {NTS}CRYPTO-003-TC1-WV提示：On-device test execution terminated:com.netflix.nts.exception.NtsFrameworkException: Restart Handler: ERROR java.lang.NullPointerException
	--8.1新版本已不能复现
3.Bug 164568 - {NTS}Android8.1 ampere版本，测试PLAY-001-TC22，error: Expected time needs to be between 35 and 55 but got 47766.033
	---8.0上解决过，已提供gerry提交及so待验证
4.Bug 165355 - {NTS}S805X测试DRS-001-TC8 PLAY-001-TC25 SYNC-002-TC5 SYNC-002-TC7 VIDEO-004-TC6现象声音比画面先出现
  Bug 164395 - {NTS}ampere版本，SYNC-002-TC5测试，声音和画面不同步
  ---已提供Tim 修改vp9不同步的patch，待验证，164395这个可能还有audio的问题，需要验证确认

本周：
 8.1 ref其它nts问题
 
myboot: netflix不能启动
otherboot:

OMX_ERRORTYPE OmxVideoDecoder::allocateBuffer(
        OMX_INOUT OMX_BUFFERHEADERTYPE **ppBufferHdr,
		
am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80125514?source=99'

csd_phyaddr=0x6700010, csd_len=50703


Bug 165355 - {NTS}S805X测试DRS-001-TC8 PLAY-001-TC25 SYNC-002-TC5 SYNC-002-TC7 VIDEO-004-TC6现象声音比画面先出现 概率：100%
sync-002-tc5  hdr10  265，没有看出不同步
VIDEO-004-TC4 hdr10  265，没有看出不同步
	---这两没有复现不同步

DRS-001-TC8 vp9 hdr 能复现不同步
play-103-tc5 vp9 different framerate，复现一次不同步
	---这两个是vp9的trig慢了一些，并且reset还触发了a-discontinue,变成vmaster，触发不同步，不去调整了
[ 2776.341846@3] A-discontinue,pcr=6000,vpts=0,apts=0,diff_pts=16191990,jump_Pts=16197990
[ 2776.348729@3] discontinue-tsync_mode:V->V,state:S->S,jiffies=25c900[ 2776.354236@3] debugcnt=0x0,diff_pts=16191990,tsync_mode=0


Bug 164395 - {NTS}ampere版本，SYNC-002-TC5测试，声音和画面不同步
	这个在bug165355里更新，在这暂无更新
	
	

05-11 07:58:38.833  2736  6640 D OmxComponent: getExtensionIndex 1101 name="OMX.google.android.index.storeMetaDataInBuffers"
05-11 07:58:38.833  2736  6640 D[ 2776.375663@3] A-discontinue,pcr=9000,vpts=0,apts=0,diff_pts=16192110,jump_Pts=16201110
[ 2776.381183@3] discontinue-tsync_mode:V->V,state:S->S,jiffies=25c920[ 2776.387750@3] debugcnt=0x0,diff_pts=16192110,tsync_mode=0
 OmxVideoDecoder: setParameter 789 0x7f000002
05-11 07:58:38.833  2736  6640 D OmxVideoDecoder:[ 2776.401333@1] success set parent gpu_p0_composite rate to 400000000
 setParameter 1269 OMX_IndexAndroidStoreMetadataInBuffers
05-11 07:58:38.833  2736  6640 E OMXNodeInstance: setParameter(0xf418[ 2776.418699@3] A-discontinue,pcr=12000,vpts=0,apts=0,diff_pts=16192950,jump_Pts=16204950
[ 2776.426007@3] discontinue-tsync_mode:V->V,state:S->S,jiffies=25c950[ 2776.432025@3] debugcnt=0x0,diff_pts=16192950,tsync_mode=0





Bug 164395 - {NTS}ampere版本，SYNC-002-TC5测试，声音和画面不同步
Bug 165355 - {NTS}S805X测试DRS-001-TC8 PLAY-001-TC25 SYNC-002-TC5 SYNC-002-TC7 VIDEO-004-TC6现象声音比画面先出现 概率：100%
	av不同步问题，vp9和hdr10 265不同步，vp9的能复现到，hdr10 265的还没有复现到

Bug 165361 - {NTS}测试PROF-006-TC3 Failed:Load the JS test, (Unavailable Video Profiles - VP9 HDR - 1080p)
	--可能与vp9的level有关
Bug 165448 - {NTS}S805X测试PLAY-101-TC7 提示 Load and verify media playback of movie ID: 80015467 and restrict streams to 'CE4' resolution(s). failed
	--可能与环境有关
	
Bug 166042 - ｛Netflix反馈问题}{NTS}S805X测试VIDEO-004-TC7 Video Resize - VP9 HDR test case failing with DRM failure
	--本地出现花屏，现象还需要与QA确认，还没有回复
[ 1177.913691@1] Skip search next start code
[ 1178.025703@1] Skip search next start code
[ 1178.173689@1] Skip search next start code
[ 1178.257751@1] Skip search next start code
[ 1178.465695@1] Skip search next start code
[ 1178.633715@1] Skip search next start code
[ 1178.833626@1] Skip search next start code
[ 1179.005578@1] Skip search next start code
[ 1179.205659@1] Skip search next start code
[ 1179.205967@1] resize_context_buffers (1280,720)=>(1280,720)
[ 1179.373321@1] success set parent gpu_p1_composite rate to 400000000
[ 1179.473233@1] [0]timeout_process decoder timeout
[ 1179.677222@1] [0]timeout_process decoder timeout
[ 1179.889221@1] [0]timeout_process decoder timeout
[ 1180.105231@1] [0]timeout_process decoder timeout
	
Bug 166111 - ｛Netflix反馈问题}{NTS}S805X 测试 PLAY-104-TC11 : Frame drop and audio loss while transitioning between content with different DRM keys
Bug 166020 - ｛Netflix反馈问题}{NTS}S805X Playback stops while playing any content using AVR and seeking by few seconds 对比:无需
	--可能DRM相关的，看drm有报错
	

Bug 165355 - {NTS}S805X测试DRS-001-TC8 PLAY-001-TC25 SYNC-002-TC5 SYNC-002-TC7 VIDEO-004-TC6现象声音比画面先出现 概率：100%
play-103-tc5帮忙抓个log
sync-002-tc5和VIDEO-004-TC4我这没有复现，帮忙抓个log，告诉怎么好的复现

Bug 166042 - ｛Netflix反馈问题}{NTS}S805X测试VIDEO-004-TC7 Video Resize - VP9 HDR test case failing with DRM failure
	--本地出现花屏，过一会应该是出现了视频卡住，这个帮忙确认下现象，如果相同现象就不用抓log了


20180514
1.编译8.0的boot.img
export BOARD_COMPILE_ATV=true

	
Bug 165746 - {Full_treble_NTS} PLAY-013-TC2 播放过程中画面不流畅，会瞬间卡顿 概率：100% 对比：无需对比 (edit) 
	--看着像audio pasue后resume error引起的 
Bug 165745 - {Full_treble_NTS} PLAY-001-TC4/PLAY-001-TC22视频播放时音画不同步，声音比画面快1.5秒 概率：100% 对比
	--应该是vp9的问题
	
PLAY-001-TC4: 加载失败，测不起来
PLAY-001-TC22: 测试同步
play-103-tc5：测试同步
DRS-001-TC7:  测试同步
AUDIO-025-TC10：看不出同步问题，我这没有画面，超时或者出现不能测试起来的情况
SYNC-001-TC7：测试同步
SYNC-002-TC7：测试同步
play-101-tc8:测试同步
	
Bug 165744 - {Full_treble_NTS} PLAY-001-TC1/PLAY-001-TC4/PLAY-001-TC22 测试过程中视频画面卡顿，画面中移动的物体有残影 概率：100% 对比：无需对比
	--原因不清楚，需要确认
Bug 165748 - {Full_treble_NTS} PLAY-001-TC1/PLAY-002-TC2/PLAY-002-TC3/SYNC-001-TC1/SYNC-002-TC1 画面跳帧 概率：100% 对比：无需对比
	--需要确认，p241是ok的
	play-001-tc1 没看出有跳帧,第一段比较模糊(walk road)，there is not crying in baseball;谈话也有一段比较模糊，
	PLAY-002-TC2：不太明显
	PLAY-002-TC3：
	play-001-tc4: step6 load,起不来 4k with5.1
	play-001-tc22: 80015473 vp9, 80006791 vp9
	
Bug 165755 - {Full_treble_NTS} PERF-006-TC1 视频播放不流畅，有卡顿 概率：100% 对比：无需对比
	--p241是ok的，需要确认，可能是网络的问题 ok
	
vp9不同步及其它tunnel mode的不同步（可能是tsync mode），使用下面的两个patch，应该就好了
http://scgit.amlogic.com:8080/43553
http://scgit.amlogic.com:8080/44149

Note：http://scgit.amlogic.com:8080/43553这个gerrit提交在openlinux-1215上是可以cherry-pick的，但在4.9最新的trunk code是有冲突的（有其它的新的提交）
这个patch更新的提交是http://scgit.amlogic.com:8080/#/c/44165/（基于最新的trunk code）
但如果使用1215的openlinux，请还使用http://scgit.amlogic.com:8080/43553，否则编译不过去

目前8.0有1215分支
commit 7fe0612767fd8a2ac710e155f155e0ae079c96fd
Author: Rongrong Zhou <rongrong.zhou@amlogic.com>
Date:   Thu Aug 31 13:56:49 2017 +0800

    DRM &  TDK to 2.4 [2/4]
    
    PD# 150073
    
       Widevine: oemcrypto-11 Android O tdk2.4 support
    
    CA: 12daec8bc37406bcf6e82906383c88de3d722064
    TA: b363dac59983e1ce6e1050627091022a199969c4
    
    Change-Id: I0ca9d1cf9633407a440903e1fe11273caa2c168a

commit 12daec8bc37406bcf6e82906383c88de3d722064
Author: Rongrong Zhou <rongrong.zhou@amlogic.com>
Date:   Wed Aug 30 15:55:06 2017 +0800

    PD#150073: Widevine-oemcrypto11 android O support & remove proprietary
    
    Change-Id: I3644de8877965a8e2897a1fae45bb134722d6b71

commit b363dac59983e1ce6e1050627091022a199969c4
Author: Rongrong Zhou <rongrong.zhou@amlogic.com>
Date:   Wed Aug 30 16:25:31 2017 +0800

    PD#150073: Widevine-oemcrypto11 Android O support & remove wv_optee
    
    Change-Id: Ie6df052a5ae7e3098790f7d1c0cd16f5135bf99c	

	
libOmxBase.so  libomx_clock_utils_alt.so libOmxCore.so  libomx_framework_alt.so  libOmxCoreSw.so libomx_timed_task_queue_alt.so  libOmxVideo.so libomx_worker_peer_alt.so libdatachunkqueue_alt.so  libstagefrighthw.so libfpscalculator_alt.so   libthreadworker_alt.so      libomx_av_core_alt.so



am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80125514?source=99'
am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80216729?source=99'
am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80156943?source=99'



echo 0x800000 > /sys/module/amvideo/parameters/debug_flag
echo 0 > /sys/module/amvideo/parameters/debug_flag

bug165744
PLAY-001-TC1 Boardwalk Twirl Ride : step25，试了4次，没有出现抖动，上周还出现过
PLAY-001-TC4 Tears of Steel:12 min:  3次没有启动测试成功

bug165748
PLAY-002-TC2 

165746 
PLAY-013-TC2 step17 人物移动切换的时候可以看到卡顿

pk0 && echo 0x800000 > /sys/module/amvideo/parameters/debug_flag;dmesg -c > /dev/null; logcat -c && logcat > now_logcat.log

am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80125514?source=99'

1.看log是第一次换key后，audio一直在skip frame，并用一个无声的frame (muted frame)替换，skip audio frame的依据是什么? 是和什么时候比较的？
20180523_15:04:19||05-23 07:04:07.378  5417  5527 I MediaDecoder2Audio: Handle PTS Gaps. ptsInMsThisFrame: 1382826, mostRecentSamplePts: 1382804
20180523_15:04:19||05-23 07:04:10.931  5417  5527 I MediaDecoder2Audio: Replace with muted package ptsInMsThisFrame: 1389866, mostRecentSamplePts: 1389887
20180523_15:04:19||05-23 07:04:10.931  5417  5527 D MediaDecoder2Audio: skipped frame 1389866

2.能否简单的介绍下同步机制


Bug 165744 - {Full_treble_NTS} PLAY-001-TC1/PLAY-001-TC4/PLAY-001-TC22/PLAY-103-TC5 测试过程中视频画面卡顿，画面中移动的物体有残影 
Bug 165748 - {Full_treble_NTS} PLAY-001-TC1/PLAY-002-TC2 画面跳帧
Bug 165746 - {Full_treble_NTS} PLAY-013-TC2 播放过程中画面不流畅，会瞬间卡顿
Bug 165745 - {Full_treble_NTS} PLAY-001-TC4/PLAY-001-TC22视频播放时音画不同步，声音比画面快1.5秒
Bug 166042 - ｛Netflix反馈问题}{NTS}S805X测试VIDEO-004-TC7 Video Resize - VP9 HDR test case failing with DRM failure 概率：100% 对比：S905X/S805X共存问题

PLAY-001-TC1: 跳帧，卡顿，有残影，有跳帧
PLAY-001-TC4/PLAY-001-TC22: 跳帧，卡顿，有残影
PLAY-002-TC2:有跳帧
PLAY-013-TC2:瞬间播放不流畅

Bug 166787 - {Full_treble_NTS}PLAY-101-TC8 Fail:Expected time needs to be between 734 and 754 but got 48464.757 
Bug 166782 - {Full_treble_NTS}AUDIO-025-TC9 Fail:Expected time needs to be between 405 and 425 but got 48135.951
Bug 166781 - {Full_treble_NTS}AUDIO-025-TC17 Fail:Expected time needs to be between 405 and 425 but got 48136.413 
	---reset过程中，获取vpts error
	
Bug 166795 - {Full_treble_NTS}PLAY-253-TC4 Fail:測試過程中畫面停住不動	
Bug 166785 - {Full_treble_NTS}PLAY-001-TC1 Failed:測試時畫面會停住不動
	--seek drop引起大量丢帧卡合住
		
Bug 166786 - {Full_treble_NTS}PLAY-101-TC5 Fail:測試過程中畫面黑屏
	--secmem增大到12M，gralloc，bl32等不匹配问题

Bug 166800 - {Full_treble_NTS}SYNC-001-TC7 Fail:測試過程中沒有聲音 概率：100% 对比：8.0此项Pass 
	---与vp9无关吧，没有声音，可能与音频解码有关，dolby digital plus 5.1
Bug 166794 - {Full_treble_NTS}PLAY-103-TC6 Fail:測試過程中沒有聲音
	--与vp9无关吧，没有声音
	
	
am start -n com.android.gallery3d/.app.MovieActivity -d  "file:////storage//wsl//LegoDemo_withAudio.mp4"
am start -n com.android.gallery3d/.app.MovieActivity -d "http://10.68.11.54:8888/dump.m3u8"


	
Bug 166795 - {Full_treble_NTS}PLAY-253-TC4 Fail:測試過程中畫面停住不動 概率：100%
   Tony：8.0 805X&905X   都Pass
Bug 166785 - {Full_treble_NTS}PLAY-001-TC1 Failed:測試時畫面會停住不動 概率：100%
    Tony：805X  Pass， 905X Fail

Bug 166786 - {Full_treble_NTS}PLAY-101-TC5 Fail:測試過程中畫面黑屏
    Tony：805X NA， 905X Pass
	
	
165748 	{Full_treble_NTS} PLAY-001-TC1/PLAY-002-TC2 画面跳帧 概率：100% 对比：无需对比 	Fri 20:47
165744 	{Full_treble_NTS} PLAY-001-TC1/PLAY-001-TC4/PLAY-001-TC22/PLAY-103-TC5 测试过程中视频画面卡顿，画面中移动的物体有残影 概率：100% 对比：无需对比 	2018-05-23
165746 	{Full_treble_NTS} PLAY-013-TC2 播放过程中画面不流畅，会瞬间卡顿 概率：100% 对比：无需对比 
165745 	{Full_treble_NTS} PLAY-001-TC4/PLAY-001-TC22视频播放时音画不同步，声音比画面快1.5秒 概率：100% 对比：无需对比 	2018-05-21





1.使用下面code本地确认的结果
http://firmware.myamlogic.com/shenzhen/image/android/Android-O/BOX/Openlinux//Android_TV/patchbuild/2018-05-29/p212-userdebug-32-GTVS-354/
PLAY-001-TC4: 加载失败，测不起来，应该是北京上不了4k的原因
PLAY-001-TC22: 测试同步，只有traffic车流量大那段感觉有轻微顿顿的感觉， boardwalk twirl ride这一段游乐园这段有点轻微的抖动
play-103-tc5：测试同步,没有异常
DRS-001-TC7:  测试同步，没有异常
AUDIO-025-TC10：看不出同步问题，视频没有异常，step17不知道音频是否异常
SYNC-001-TC7：测试同步，没有异常
SYNC-002-TC7：测试同步，没有异常
PLAY-101-TC8：测试同步，没有异常
2.确认同步问题时，要先用“cat /sys/class/tsync/mode” ，确认是“1: amaster”，否则使用“echo 1 > /sys/class/tsync/mode”后并cat确认生效后，再确认同步问题
3.若出现同步问题时，使用“cat /sys/class/tsync/mode”是否是amaster模式，若不是是按照2中再测试下，否则请抓对应的log（setprop media.omx.log_levels 255，测试之前设置），并录下视频方便确认问题
4.为方便确认问题，请出问题要录个视频和抓log（setprop media.omx.log_levels 255，测试之前设置）


play-001-tc1（264） traffic这一段有轻微的顿顿的感觉，但应该不是跳帧，与play-001-tc22（vp9）差不多的感觉，只是两个是不同的视频格式
PLAY-002-TC2：step7有点不流畅的感觉（流水声开始的地方，就是一开始的地方）
本地有录像，ftp地方，，需要QA确认下跳帧的现象是否是我录像的位置，若不是请帮忙录下像，确认下位置

echo 0 > /proc/sys/kernel/printk && echo 1 > /sys/class/tsync/debug_video_pts && echo 1 > /sys/class/tsync/debug_pts_checkin && echo 1 > /sys/class/tsync/debug_pts_checkout;dmesg -c > /dev/null; logcat -c && logcat > now_logcat.log

获取vfm的pts
sed -n 's/.*pts:\(.*\) \\x09d.*/\1/p'   pts
sed -n 's/.*\\x09t:\(.*\)Us/\1/p'       time
sed -n 's/.*\] \(.*\): \\x09vf.*/\1/p'  num

libOmxBase.so             libomx_clock_utils_alt.so       libOmxCore.so             libomx_framework_alt.so libOmxCoreSw.so           libomx_timed_task_queue_alt.so  libOmxVideo.so            libomx_worker_peer_alt.so  libdatachunkqueue_alt.so  libstagefrighthw.so    libfpscalculator_alt.so   libthreadworker_alt.so libomx_av_core_alt.so 

am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80015468?source=99'
am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent>.action.VIEW -d 'https://www.netflix.com/watch/80015474?source=99'

am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d '[图片]https://www.netflix.com/watch/80015468?source=99'

pk0 && echo 0x800000 > /sys/module/amvideo/parameters/debug_flag;dmesg -c > /dev/null; logcat -c && logcat > now_logcat.log

待烧写的boot.img copy到u盘，备份的bootimg也将保存到u盘，下面的操作cd到u盘目录操作
1.备份boot.img
cat /dev/block/boot > bootbak.img

2.烧写编译的boot.img，确认问题
cat boot.img > /dev/block/boot && sync && reboot
-
3.确认完问题后，可以恢复boot.img
cat bootbak.img > /dev/block/boot && sync && reboot


echo 0 > /proc/sys/kernel/printk && dmesg -c > /dev/null && echo 0x800000 > /sys/module/amvideo/parameters/debug_flag


echo 0 > /proc/sys/kernel/printk && dmesg -c > /dev/null;echo 0x800000 > /sys/module/amvideo/parameters/debug_flag;logcat -c && logcat > logcat.log
出现卡顿输入下面抓log
echo 0 > /sys/module/amvideo/parameters/debug_flag && dmesg > k_vfm.log

8M->12M相关提交
1.omx so
http://scgit.amlogic.com:8080/45932  

2.bl32,trunk上的提交
http://scgit.amlogic.com:8080/#/c/45064/
commit 33ba3c6c97207c5ba04dfeba8beef81db09a7b0f (HEAD, m/o-mr1-amlogic, m/o-amlogic, amlogic/tdk-v2.4)
Author: Pengguang Zhu <pengguang.zhu@amlogic.com>
Date:   Mon May 28 11:27:51 2018 +0800

    secueos: udpate G12A/GX/TXLX/AXG bl32 firmware

    PD#167143

    1. use small page for user TA

    Secure OS:
    commit: 0704d5b5561a2230f19658e05944bbcff435db22

3. wv
http://scgit.amlogic.com:8080/#/c/45947/


13 Reasons why

hdmi60hz -> 59.94 1.001 clock
echo 0 > /sys/class/amhdmitx/amhdmitx0/frac_rate_policy

setenv frac_rate_policy 1
save
reset

echo 1,1,1 > /sys/module/amvideo/parameters/pts_log_enable

echo 1,1,1 > /sys/kernel/debug/video/pts_log_enable


echo 1,1,1 > /sys/kernel/debug/video/pts_enforce_pulldown


上周：
168127 {Netflix反馈问题 #111}测试PLAY-015-TC1 有卡顿现象 概率：100% 对比：一直存在以前测试没注意到S805X和S905X共存问题
	---相关patch已提交，24fps有卡顿是已知问题，等netflix反馈
Bug 168583 - [R33A2-客户反馈DANGAL#691-System]：film mode功能不正确，播放24p码流时画面卡顿明显，100%
	---输出正常，对比sony有MEMC功能，不开EMMC也都存在卡顿，FAE在说明客户接受
Wetek NTS测试DRS-001-TC4画面顿一下的问题
	---已提供相关的patch，等反馈
	
am start -n com.android.gallery3d/.app.MovieActivity -d http://10.68.11.62:8800/dts-express/index.m3u8
am start -n com.android.gallery3d/.app.MovieActivity -d http://10.68.11.62:8800/dump/index.m3u8
am start -n com.android.gallery3d/.app.MovieActivity -d file:///storage/2940-157B/mi-tv-play/


抓audio数据
setprop media.omx.audio.debug 1
setprop media.omx.audio.dump 1
mkdir /data/tmp
chmod 777 /data/tmp -R
setenforce 0


debug for patchbuild openlinux1215 8.0
 http://scgit.amlogic.com:8080/47140
 
 
打印内存
 echo 0x30 > /sys/module/codec_mm/parameters/debug_mode
 
debuggerd -b $(pidof media.extractor)
debuggerd -b $(pidof mediaserver)
debuggerd -b $(pidof media.codec)
debuggerd -b $(pidof surfaceflinger)

上周
168642 {GTS}8.0 P212 GTS测试，Tests Failed 14（14个fail项） ，概率：100%,对比：无需对比。 
168583 [R33A2-客户反馈DANGAL#691-System]：film mode功能不正确，播放24p码流时画面卡顿明显，100% 
168951 [阿里巴巴梵高-S905X2-8.1-DTS]: 在线dts-express视频文件无法播放。
169066 {DTS} HLS播放DTS流失败，DTS Streaming认证模块无法进行。100%，对比：Dolby流和普通PCM流正常。 
168127 {Netflix反馈问题 #111}测试PLAY-015-TC1 有卡顿现象 概率：100% 对比：一直存在以前测试没注意到S805X和S905X共存问题
	--fixed
169137 [R31A4-客户反馈DANGAL#1193-Video]：[V23N] 播放U盘内的视频, 进行快进快退操作后, 画面静止, 视频播放异常, 提示: Play failed. Error(100,1) 
	--amnuplyer退出播放，mediacodec的flush时，卡在ACodecBufferChannel的std::atomic_load，原因需要再分析
	
本周：
169137 [R31A4-客户反馈DANGAL#1193-Video]：[V23N] 播放U盘内的视频, 进行快进快退操作后, 画面静止, 视频播放异常, 提示: Play failed. Error(100,1) 
netflix反馈问题
其它问题


169137 	[R31A4-客户反馈DANGAL#1193-Video]：[V23N] 播放U盘内的视频, 进行快进快退操作后, 画面静止, 视频播放异常, 提示: Play failed. Error(100,1)
	---卡在std::atomic_load(&(input ? mInputBuffers : mOutputBuffers)))，没有找到根本原因，已提供暂时避免的办法
169357 	[Ref#Bug 169513-R31A4-T960x-8.1-System]：Movieplayer本地播放《AVS+_E-AC320.6 Mbps-720x576.ts》退出播放--mediacodec内存泄露
	---liuyao已有相应的patch
169116 	[R33A2-MIUI-Video]：本地多种格式视频循环播放煲机12h画面卡住
	---去掉avs源后暂时没有复现，需要进一步煲机
169021 	[R31A4-客户反馈DANGAL#1018-Video]：[V23N]播放ts视频，后台一直打log
	---interlace片源bottom场的pts为0或者与top一致，log已去掉
	
echo 1 > /sys/module/amvideo/parameters/video_dbg_vf;
echo 0x800000 > /sys/module/amvideo/parameters/debug_flag;echo 0 > /proc/sys/kernel/printk && dmesg -c > /dev/null; logcat -c && locat > logcat.log

dmesg > kernel.log

cat /sys/class/vdec/dump_vdec_chunks;cat /sys/class/amstream/bufs;echo dump decoder > /sys/class/vfm/map 


169611 	[Wetek-S905X-客户反馈-Netflix-Video]Netflix播放某节目，会几率性出现丢帧、视频卡顿的问题。 在7.1上复现几率较高，并且现象比较明显。8.0也可复现，但几率不高 
	---数据下溢，已加大secmem的大小，4k以下使用2.8M内存，客户已送测
169714  [P21A7-S905X-8.1-NTS]:SEC-978-TC2 Video freeze frequently(100%)
	---
169578 	[MINI-R33A2-T950X-Video]:小米版本，本地视频[LG.4K.演示片]韩国女子组合20_T-ara_No.9.ts播放+seek煲机，退出、再进入播放时，卡死在加载界面，操作遥控器无反应。 


setprop media.omx.audio.debug 1

setprop media.omx.out_buffer2 8


1. 用usrdebug版本：setprop libc.debug.malloc.options "backtrace guard"
2. setprop libc.debug.malloc.program media.codec
3. kill掉media.codec进程, kill $(pidof media.codec)
4. 设置prop
	setprop media.hls.ptsdebug 4
	setprop media.omx.log_levels 255
	setprop media.omx.audio.debug 1
5.煲机

cat /sys/class/vdec/core
cat /sys/kernel/debug/vdec_profile/event

debuggerd -b $(pidof mediaserver)
debuggerd -b $(pidof surfaceflinger)
debuggerd -b $(pidof media.codec)

07-26 19:13:51.887506  9960 10198 E NdkMediaCodec: sf error code: -13

170411 [R31A2-Customer Feedback#4317-Video]： VLC播放视频反复快进，画面卡住，退出再播放黑屏
	---已提供两个煲机patch，还没有复现问题
169752 {NTS Bug CJHFCNAMLX-28} PLAY-103-TC5 - fails as A/V sync is off w/ VP9 HFR content w/ DDP decode capable panel
	---输入输出buffer少引起的解码输出慢，vp9的问题先waive，后面netflix会继续跟进
170496 [R33A2-客户反馈-DANGAL-1929-Video]：[V23N][工厂反馈]U盤播放4K測試檔案時, 檔案內容播完後, 無法再次播放(電視重啟後, 操作正常,概率約 6/30 )
	---已提供patch，还没有复现问题
169855 {NTS}测试SYNC-002-TC8播放视频没有画面同时还存在杂音 概率：100% 对比：S805X/S905X共存 之前测试正常
	---fixed

12-31 16:34:18.320  2816  2962 I chatty  : uid=0(root) HwBinder:2816_3 identical 6 lines
12-31 16:34:18.321  2816  2962 I SystemControlHal: getPropertyBoolean key :sys.videoplayer.debug, value:0
12-31 16:34:18.322  8995  8995 W MediaPlayer: Couldn't open /storage/6CE5-9FB0/170750/iPhone7-2160x3840-Vertical-30fps.MOV: java.io.FileNotFoundException: No content provider: /storage/6CE5-9FB0/170750/iPhone7-2160x3840-Vertical-30fps.MOV
12-31 16:34:18.326  2895  2991 E MediaPlayerService: offset error
12-31 16:34:18.326  8995  8995 E MediaPlayerNative: Unable to create media player
12-31 16:34:18.326  8995  8995 E VideoPlayer: Unable to open content: /storage/6CE5-9FB0/170750/iPhone7-2160x3840-Vertical-30fps.MOV,ex:java.io.IOException: setDataSourceFD failed.: status=0x80000000
12-31 16:34:18.327  9233  9233 I SubTitleServer: [SubTitleServer]
12-31 16:34:18.327  9233  9233 I SubTitleServer: [onCreate]
12-31 16:34:18.327  2816  2962 I SystemControlHal: getPropertyBoolean key :sys.videoplayer.debug, value:0
12-31 16:34:18.327  9233  9233 I SubTitleServer: [onBind]
12-31 16:34:18.330  2895  4258 E MediaPlayerService: offset error
12-31 16:34:18.330  8995  8995 E MediaPlayerNative: Unable to create media player


[   63.409962@2] after ionvideo_fillbuff
[   63.411337@2] before ionvideo_fillbuff
[   63.415156@2] before ge2d_paint_dst
[   64.433963@3] after ge2d_paint_dst
[   64.434018@3] after ionvideo_fillbuff
[   64.435384@3] before ionvideo_fillbuff
[   64.441369@3] before ge2d_paint_dst
[   65.457901@0] after ge2d_paint_dst
[   65.457948@0] after ionvideo_fillbuff
[   65.459385@0] before ionvideo_fillbuff
[   65.463476@0] before ge2d_paint_dst
[   66.481919@1] after ge2d_paint_dst
[   66.481966@1] after ionvideo_fillbuff
[   66.483337@1] before ionvideo_fillbuff
[   66.487315@1] before ge2d_paint_dst
[   67.505913@3] after ge2d_paint_dst
[   67.505954@3] after ionvideo_fillbuff
[   67.507347@3] before ionvideo_fillbuff


#内存
cat /sys/class/codec_mm/config
cat /sys/class/codec_mm/codec_mm_dump
cat /sys/class/codec_mm/codec_mm_scatter_dump

cat /sys/class/decoder_bmmu_box/box_dump
cat /sys/class/decoder_mmu_box/box_dump

测试前设置
echo 0x30 > /sys/module/codec_mm/parameters/debug_mode 

每次播放刚开始的时候dump
cat /sys/class/codec_mm/codec_mm_dump

出问题时dump
cat /sys/class/codec_mm/codec_mm_dump
cat /sys/class/codec_mm/codec_mm_scatter_dump
cat /sys/class/decoder_mmu_box/box_dump
cat /sys/class/decoder_bmmu_box/box_dump
cat /sys/class/codec_mm/codec_mm_keeper_dump


For HFR VP9, the decode operation is complex, requires more bandwidth, and  also has higher requirements for data input efficiency.
The DDR bandwidth  calculation formula is as follows in theory:
DDR freq×2× bit width（16/32/64）/ 8 ×efficiency（75%）
805x Soc, bandwidth =1G*2*16/8*0.75=
理论上分给解码器的带宽是xx，
理论总带宽是DDR freq×2× bit width（16/32/64）/ 8 ×efficiency（75%）
3840x2060x1.5/10=1186560
高码率 50

可以说vp9运算复杂，需要带宽更多，对数据输入效率有要求更高
就我前面说的这个吧，强调vp9运算复杂度导致带宽要求高吧

echo 0x800000 > /sys/module/amvideo/parameters/debug_flag 
echo 0x4841 > /sys/module/amvdec_h265/parameters/debug


cat /sys/class/video/disable_video

171345 [阿里巴巴-S905M2-6.0-audio]：TV助手本地投屏音乐，播放到马上结束时暂停播放
	---fixed
171461 {Netflix反馈问题#148}{NTS}测试SYNC-002-TC5 : Macro blocking during video playback during first 40secs-1min 概率：连续测试6次后出现，复现之后就100%必现
	--fixed
video peek
	--ongoning
	1.hevc docoder没有及时输出第一帧，添加3k的padding数据也不有及输出。打开一些debug，第一帧能及时peek到，原因不知道；
	2.zhanghui分析kernel log，第一帧解码出来了，但是没有及时输出，目前pengyixin在协助处理第一帧输出问题；

1.
video peek, hevc ok
hevc.ko + omx.so + boot.img
http://firmware.myamlogic.com/shenzhen/image/android/Android-O/MR1/Android_TV/trunk/2018-08-21/p212-userdebug-32-GTVS-316/

2.
SEC-924-TC1 在r321上是pass，0822 patchbuild
SEC-978-TC20 not ok，需要4k，应该是上不4k的原因，黑屏
SEC-978-TC15 pass
SEC-924-TC1  pass

am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80996905?source=99'


audio fd leak
http://scgit.amlogic.com:8080/#/c/50602/
http://scgit.amlogic.com:8080/#/c/50623/

VPEEK-001-TC1-Tunnel, VPEEK-001-TC2-Tunnel, VPEEK-001-TC3-Tunnel

fastboot flashing unlock
fastboot flash vbmeta vbmeta.img
fastboot reboot

fastboot flashing unlock 
fastboot flashing unlock_critical

#HDR
echo rh1000101a > /sys/class/amhdmitx/amhdmitx0/debug
cat /sys/module/am_vecm/parameters/hdr_mode
cat /sys/class/amvecm/hdr_dbg
cat /sys/module/am_vecm/parameters/cur_csc_type
红色方框，0910是hdr的
0101是sdr的

 ACodec  : Configuring TUNNELED video playback.

172444 {HDR}{system}播放4K VP9的HDR片源，使用命令cat /sys/module/am_vecm/parameters/cur_csc_type的节点是16；概率：100%；对比S905X P212+Android N正常。
	---fixed
172137 ｛netflix｝support Ninja 6.0 video peek(tunnel mode)功能
	---
171345 [阿里巴巴-S905M2-6.0-audio]：TV助手本地投屏音乐，播放到马上结束时暂停播放 	Wed 18:06
171583 	{NTS}Manual,DRS-001-TC6 Failed step 5 The probability of losing a frame or fast-forward when switching to a moving frame Probability: 80% contrast: no need 	Wed 16:34
172382 	[Harman-T962E-HDR]:HDR dosen't work 

am start


        pProfileLevel->eProfile = kProfileLevels_AVC[pProfileLevel->nProfileIndex].mProfile;
                    pProfileLevel->eLevel = kProfileLevels_AVC[pProfileLevel->nProfileIndex].mLevel;
            

Planet Earth II   S1 EP1  3'15''`3'17''出现问题

dolby atmos 4k

libOmxAudio.so   libdatachunkqueue_alt.so   libomx_timed_task_queue_alt.so libOmxBase.so    libfpscalculator_alt.so    libomx_worker_peer_alt.so libOmxCore.so    libomx_av_core_alt.so      libstagefrighthw.so  libOmxCoreSw.so  libomx_clock_utils_alt.so  libthreadworker_alt.so    libOmxVideo.so   libomx_framework_alt.so

openlinux 1215 profilelevel
netflix-profilelevel
http://scgit.amlogic.com:8080/51184
http://scgit.amlogic.com:8080/#/c/51207/

trunk
http://scgit.amlogic.com:8080/#/c/51212/


Now it can be tested normally, test code as follows:
http://jenkins-sh.amlogic.com:8080/job/android/job/Android_P/job/Android_P_PATCHBUILD/1055/

patch：

http://scgit.amlogic.com:8080/50266

http://scgit.amlogic.com:8080/50309

omx source code:

http://scgit.amlogic.com:8080/50242
test account:
shuanglong.wang@amlogic.com
test case :VPEEK-001-TC1-Tunnel, VPEEK-001-TC2-Tunnel, VPEEK-001-TC3-Tunnel
netflix apk：netflix-ninja-5.3.3-102326-debug.apk
Above nts test case ok(only have  hevc case)

We are trying simple media CTS.



0920
/sys/module/amdolby_vision/parameters/dolby_vision_enable
/sys/class/amdolby_vision/dv_mode
/sys/module/amdolby_vision/parameters/force_stb_mode

o-mr1-amlogic
dv diff
http://scgit.amlogic.com:8080/51852
http://scgit.amlogic.com:8080/51853

echo 2 > /sys/module/amdolby_vision/parameters/debug_dolby




173678 	{gts}[S905X 2G]:GtsMediaTestCases模块有4个Fail项;概率:100%;对比:v0912新出现,p241也出现
	--fixed
173876 	[Ampere P]{HDR}Netflix/movieplay播放HDR源，平台自己解码输出画面黑白，自己解码或者透传给tv解码osd均黑屏显示；概率：（100%）；对比：v0918新增，trunk ok
	--fixed
173738 	{cts}[S905X]:android.media.cts.DecoderTest#testH264SecureDecode60fps1920x1080Tv测试Fail
	--fixed
173676 	{AV}:KODI上播放HDR视频后，播放所有4K H265视频，画面颜色失真 概率：50% 对比：0912 trunk和drawin P上也有此问题
	--fixed
172452 	{Dolby Vision}{System}平台接第三方SDR电视机，播放DV片源时使用命令cat /sys/class/amdolby_vision/dv_mode获得节点是Bypass;概率：100%；对比S912 Q201+Android N正常 
	--fixed
173668 	{Dolby Vision}{AV}平台播放DV to HDR和DV to SDR视频自动快进效果；概率：100%；对比对比S912 Q201+Android N正常
	--ongoning，原生nuplayer对回环流的支持不好，已提供patch，本地确认是ok
173350 	[烽火海外IPTV-S905X-8.0-video]：直播卡顿，dump出来的流有马赛克，本地播放流畅。要求优化网络播放卡顿，将错误帧也播放出来 
	--ongoing，可能单个板卡硬件问题
	
	
http://firmware-old.amlogic.com/shanghai/image/android/Android-P_Google_P-tv-dev//Android_TV/patchbuild/2018-09-13/atom-user-32-GTVS-1270/这个版本还是好的
11:22:05
袁洁 2018/9/27 11:22:05
http://jenkins-sh.amlogic.com:8080/job/android/job/Android_P/job/Android_P_Google_TV_DEV_PATCHBUILD/1330/这个版本的固件就fail了

sys.media.omx.vr
media.omx.display_mode

P上dv的extractor部分已经可以了，但目前看dolbyvision的4.9适配还有点问题
1) 这两个malloc有问题，没有实体，导致kernel crash
pq_config =  vmalloc(sizeof(pq_config));
dovi_setting = vmalloc(sizeof(dovi_setting));
2) p_funcs->tv_control_path这个调用也有问题，没有函数指针的判断，导致PC为0 crash
3) 不能正常播放，8.1和p都是同样的问题，tv_mode修改成1也，force_stb_mode打开能出颜色错误的图像
4) dovi_txlx_stb_24_4.9.ko和dovi_txlx_stb_24_demo_4.9.ko都试过也不行
http://10.18.11.97/shanghai/image/android/Android-P//Android_TV/patchbuild/2018-10-01/t962x_r311-userdebug-32-GTVS-1849/
http://10.18.11.97/shanghai/image/android/Android-O/MR1//Android_TV/patchbuild/2018-10-01/t962x_r311-userdebug-32-GTVS-4602/


dv不能show的patch
http://scgit.amlogic.com:8080/#/c/51422/  wangjian
http://scgit.amlogic.com:8080/51852



Bug 173990 - {NTS}Android P test PLAY-001-TC1 Play video video caton contrast:no need 
Bug 173121 - {NTS}Manual test,PLAY-103-TC4,Step#4,视频中火的部分视频异常，动态有阴影。probability:3/3.contrast:P212_O Normal.
Bug 173094 - {NTS}Manual test,HDR-001-TC1,HDR-002-TC2,Step#1 Failed.Play 80174402 for 5 seconds without graphics,contrast:no need


android.media.cts.DecoderTest#testHEVCDecode30fps3840x2160	
android.media.cts.DecoderTest#testVP9Decode30fps3840x2160	
android.media.cts.DecoderTest#testVP9Decode60fps3840x2160	
android.media.cts.StreamingMediaPlayerTest#testHTTP_H264Base_AAC_Video2	
android.media.cts.VideoDecoderPerfTest#testAvcOther0Perf0320x0240	
android.media.cts.VideoDecoderPerfTest#testAvcOther0Perf1280x0720	
android.media.cts.VideoDecoderPerfTest#testVp9Other0Perf0320x0180


Try to start any automated test case(preferably HDR) in a stress of 30 times and randomly in between the stress run netflix 
application crashes and loose connection with the monitor and never returns to Hone screen. Only way to recover is to unplug 
HDMI cable and replug or reboot the device   

10-03 14:09:31.600  2902  3098 I ActivityManager: Force stopping com.netflix.ninja appid=10065 user=0: from pid 6918   
10-03 14:09:31.604  2902  3098 I ActivityManager: Killing 6761:com.netflix.ninja/u0a65 (adj 0): stop com.netflix.ninja   
10-03 14:09:31.609  2902  3098 W ActivityManager: Scheduling restart of crashed service com.netflix.ninja/.NetflixService in 1000ms   
10-03 14:09:31.610  2902  3098 W ActivityManager: Force removing ActivityRecord\{fd52f48 u0 com.netflix.ninja/.MainActivity t1819}: app died, no saved state   

http://scgit.amlogic.com:8080/52340			//h265
http://scgit.amlogic.com:8080/#/c/52437/    //ogg



echo "1,1,1" > /sys/kernel/debug/video/pts_log_enable
echo 0x400000 > /sys/module/amvideo/parameters/debug_flag

pattern 32323
http://scgit.amlogic.com:8080/52528

http://scgit.amlogic.com:8080/52548 o-openlinx-1215

stet he chimera

<MediaCodec name="OMX.google.raw.decoder" type="audio/raw" />        
        <MediaCodec name="OMX.amlogic.audio.decoder.ac3" type="audio/ac3" />
        <MediaCodec name="OMX.amlogic.audio.decoder.eac3" type="audio/eac3" />
        <MediaCodec name="OMX.amlogic.audio.decoder.dtshd" type="audio/dtshd" />

http://10.68.11.62:8800/latm/index.m3u8




上周：
SWPL-310 Android P from trunk0926 version, movieplayer can't playback some video of unsupported audio track Frequency: 10/10 of the times comparison: trunk0925 normal
	---已修改amnuplayer，但目前mainline无法验证（没有打开amnuplayer，原生的nuplayer无此问题），建议降低优先级或先pengding
173406 	{Dolby Vision}，R311 Android P平台需添加Dolby vision功能。参考Android 7.1平台。
	---dolby相关的问题已上gerry，由于tv平台还没有release ko（目前给的stb的ko），需要Frank他们release
SWPL-374 {NTS}Android P test PLAY-001-TC1 Play video video caton contrast:no need
	---ongoning，初步有patch，但需要与QA对下问题
SWPL-376 {NTS}Manual test,PLAY-103-TC4,Step#4,视频中火的部分视频异常，动态有阴影。probability:3/3.contrast:P212_O Normal.
	---未开始，可能需转给处理HDR的同事处理
支持netflix反馈的805x 8.0起播放卡顿问题
支持烽火反馈的latm网络播放不识别问题

echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
echo 1,1,1 > /sys/kernel/debug/video/pts_log_enable


从Ampere patchbuild1015-311开始.RealMagic MPEG-4 and VP8 codec 视频 Resume play后黑屏，无法播放。Ampere P patch1015-309是正常的
	---新的代码已经没有这个问题了
不支持音轨的视频播放黑屏，问题已经改好，未合并到mainline版本
	---已经merge到mainline， http://scgit.amlogic.com:8080/#/c/52973/
默认走android extractor，部分codec视频无法播放，走amlogic extractor可以播放
	--正在添加支持，需要把对应放到amlogic extractor的白名单里，再过下media cts项

	
netflix 60fps播放
stet
wanderlust

Bug 174217 - [Harman-T962E-CTS]：用9.0_r2包测试CtsMediaTestCases包有3项fail 概率：100%
	---fixed
SWPL-874 {Dolby vision}{AV}The brightness and saturation has no change when play MP4 
	---fixed
SWPL-518 {NTS}{manual}VIDEO-RESIZE-HDR10-TC1/TC3 (H.265)AV sync issues after playback a few minutes 
	---audio问题，audio更新后无此问题，已转xujian
SWPL-658{Dolby Vision}{AV}The MP4 formats combine video of dvhe.dtr of Adaptive_Streaming_Tests folders in Dolby vision certification folders can't play to the end;Frenquency
	---目前只还有一个异常流不能播放完，不打开dv也会马赛克，先不处理
google-atom-17789106 [Atom NTS] Test v5.1 error mismatch: Playback PLAY-258-TC1
	---目前atom复现不了
	
yongbin，今天对一下问题哦，这三个，可能需要你那边配合搞下log
SWPL-799 {NTS}Manual Run Audio-007 -TC1-NonTunnel, step 10, crash
SWPL-842 {NTS}Test PLAY-015-TC3 Close media playback is fail
	---目前新的睡醒没有些问题，
SWPL-795 {NTS}EyePatch test cases: DRS-HDR10-25FPS-HEAAC-DWN and DRS-HDR10-25FPS-HEAAC-UP fail


[  125.364907@0] type=1400 audit(1540999471.312:192): avc: denied { connectto } for pid=5314 comm="Binder:5314_1" 
path="/dev/socket/property_service" scontext=u:r:mediaextractor:s0 tcontext=u:r:init:s0 tclass=unix_stream_socket permissive=0
 duplicate messages suppressed
 
DYNASTY


SWPL-799{NTS}Manual Run Audio-007 -TC1-NonTunnel, step 10, crash
SWPL-842{NTS}Test PLAY-015-TC3 Close media playback is fail
	---fixed，这两个已无此问题
SWPL-1151{Dolby vision certification}{AV}There are observable changes in brightness or saturation when test Negative test.
	---reopened，目前还有一个视频有问题，可以此视频在7.1上也有问题
Bug 171122 - [华曦达-S905X-客户反馈-NTS]:AUDIO-023-TC5-fail(100%)
	---fixed




--- a/arch/arm64/configs/meson64_defconfig
+++ b/arch/arm64/configs/meson64_defconfig
@@ -11,7 +11,7 @@ CONFIG_TASK_XACCT=y
 CONFIG_TASK_IO_ACCOUNTING=y
 CONFIG_IKCONFIG=y
 CONFIG_IKCONFIG_PROC=y
-CONFIG_LOG_BUF_SHIFT=19
+CONFIG_LOG_BUF_SHIFT=23


http://scgit.amlogic.com:8080/54480  drop

http://scgit.amlogic.com:8080/#/c/54509



SWPL-1145 {Dolby vision certification}{AV}It is fail when test Dolby Vision profile 4 FEL negative test.
	---fixed
SWPL-989 {Franklin P}{Dolby Vision}When connect to SDR TV,it will Bypass when play DoViTrailer_MP4_with_Atmos.mp4
	---fixed
SWPL-1126 {Dolby vision}{AV}There are some videos can't play in Dolby Vision certification test vector folder after burn ko;Frequency
	---ongoning,目前还有两个流不能正常播放
SWPL-1151{Dolby vision certification}{AV}There are observable changes in brightness or saturation when test Negative test.
	---reopened，目前还有一个视频有问题
	
	
开始测试前
echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
echo 1,1,1 > /sys/kernel/debug/video/pts_log_enable
echo 0 > /proc/sys/kernel/printk; dmesg -c > /dev/null
echo 3 > /sys/module/amvideo/parameters/video_dbg_vf

感觉会出现卡顿前输入 dmesg -c > /dev/null
出现卡顿后(可以包含几个卡顿)输入 dmesg > kernel.log

adb push boot.img /data
cd /data; cat /dev/block/boot > bootorg.img      //备份bootimg
cat boot.img > /dev/block/boot && sync && reboot   //替换

cat /sys/module/amvideo/parameters/underflow
setprop media.omx.out_buffer1 6
scp xiaoliang.wang@10.18.11.213:/mnt/fileroot/xiaoliang.wang/p-mirror/out/target/product/atom/boot.img .


open widevin45.544 12717 12717 V CodecCapHelper:  codecName: OMX.amlogic.dolby-vision.decoder.awesome.secure                                                 
OEMCrypto_Ge45.544 12717 12717 V CodecCapHelper:   Type: video/dolby-vision, isAdaptive: true, isSecurity: true, isTunneled: true                                                   
open widevin45.545 12717 12717 V CodecCapHelper:    profile: 16, levels: [256]                                                                                                      
open widevin45.546 12717 12717 V CodecCapHelper:    profile: 32, levels: [256]                                                                                                     
OEMCrypto_Ge45.546 12717 12717 V CodecCapHelper:    profile: 64, levels: [256]                                                                                
open widevin45.546 12717 12717 V CodecCapHelper:    profile: 128, levels: [256]                                                                                                     
open widevin45.547 12717 12717 V CodecCapHelper:    profile: 256, levels: [256]                                                                                                     
open widevin45.547 12717 12717 V CodecCapHelper:    profile: 512, levels: [256]                                                                                                     
open widevin45.547 12717 12717 V CodecCapHelper:    profile: 1, levels: [256]                                                                                                       
open widevin45.548 12717 12717 V CodecCapHelper:    profile: 2, levels: [256]                                                            
open widevin45.548 12717 12717 V CodecCapHelper:    profile: 4, levels: [256]                                                                                                       
open widevin45.549 12717 12717 V CodecCapHelper:    profile: 8, levels: [256]


第二个时videopeek与这个功能冲突不，因为目前videopeek是立即显示第一帧
Is it complict with video peek? Now video peek will render the first frame once the first frame is decoded.
Do netflix app send any message to control the timing to render the first frame?


11-22 02:34:18.662 15980 16057 E OmxVideoDecoder: OMX_IndexParamSupportVPeekInTunnel setParameter 1660, videopeek:1
11-22 02:34:18.662 15980 16057 D OmxVideoDecoder: getConfig 1674 0x6f100004 

11-22 02:34:18.973 15980 16126 D AmlogicVideoDecoderAwesome: media.omx.videopeek 0                                 
11-22 02:34:18.973 15980 16126 V AmlogicVideoDecoderAwesome: mFlvFlag=0


http://scgit.amlogic.com:8080/52528
http://scgit.amlogic.com:8080/55892

nts问题
	SWPL-44 netflix video peek feature supprot
		---videopeek的修改，这个等netflix的app添加vendor.nrdp.support-video-peek-in-tunnel再提交
			netflix可能会在mediacodec的execting状态设置videopeek，bug里gerry的提交应该不需要修改的
	SWPL-795 {NTS}EyePatch test cases: DRS-HDR10-25FPS-HEAAC-DWN and DRS-HDR10-25FPS-HEAAC-UP fail
		---amperer nts 23fps, 29fps, 59fps应该能pass 30, 24, 25, 50,可能发生drop，16s drop一次	
	SWPL-1955 {NTS}{Manual}PLAY-001-TC14: playback is not smooth with dancers-couple chapter
		---atom的nts，hdmi 1.001 shift问题，原录安已经提交gerry，xiaoliang已经提供给google，google还没有验证
	SWPL-2013{NTS}Automated case ,Video play is not smooth, such as :SEC- 990-tc1 cases
		---u212的nts，应该就是这样的case，8.0，8.1之前也都是这样效果。
    SWPL-2002 {NTS}Automated Test PROF-001-TC14 Step #1 Failed: Load the JavaScript Test, (Verify HDR Video Profiles - Dolby Vision - 4K) to be executed on the device and wait for completion
		---u212的nts，能检测到dv的profile，应该是是没有使用dv的电视确认
	SWPL-1008 {NTS}Eyepatch 60 DV /59.94 DV Lose frames 10 seconds before playback
		---8.0的nts起播放卡顿问题，深圳yongbin只复现过一次
	SWPL-2317 {Netflix}CLONE - [P252-S905X-8.0-Customer feedback-Video]:Play Netflix movie《22JULY》, red artifacts appears in the video(100%)
		---小米的netflix播放问题，还没有看
	
dolbyviion问题
	SWPL-1656{Dolby Vision certification}{AV}It will exit to home or display Unsupport media when play SDR MP4 source in Test_Vectors/SDR/Adaptive_Streaming_Tests of Dolby vision certification.Frequency：5/5.Comparison results:No need.
		---原味生mpeg4extractor,过认证的话，设置setprop media.ffmpegextractor.force true，就没有此问题了
	dolbyvision应该没有其它parse方面的问题了，7.1之前的patch 上面的加上之前的已经merge的，已经全了


20181217
SWPL-1656 {Dolby Vision certification}{AV}It will exit to home or display Unsupport media when play SDR MP4 source in Test_Vectors/SDR/Adaptive_Streaming_Tests of Dolby vision certification.Frequency：5/5.Comparison results:No need
	---fixed，原生mp4extractor的问题，32拉数越引起的crash，待QA验证
SWPL-1174 {Dolby vision certification}{AV}The screen is frozen when play the source in Longevity_Tests/ folder;Frequency：3/3;Comparison results:No need
	---ongoing，煲机问题，QA复现中
SWPL-1285 {Dolby vision certification}{AV}The TV display black Screen when play "Okja" with netflix after set Dolby vision Enable.Frequency：3/3.Comparison results:Dolby vision Disable is OK
	---core的问题，与zhouyi商量，转过去处理
	
4353485 12-14 14:30:56.543  3151  3423 D BufferLayer: AML_VIDEO_OVERLAY come in, vaddr: 0xec390000
4353486 12-14 14:30:56.544  3310  6306 D OmxComponent: fillThisBuffer pBufferHdr 0xec797aa0 nAllocLen 12441600 nFilledLen 0
4353487 12-14 14:30:56.544  3310  6306 D AmlogicVideoDecoderAwesome: fillThisBuffer
4353488 12-14 14:30:56.545  3151  3201 D BufferLayer: AML_VIDEO_OVERLAY come in, vaddr: 0xec372000
4353489 12-14 14:30:56.550  3310 21028 D AmlogicVideoDecoderAwesome: In PTS 123790333,  nFilledLen=83250, bufferHdr.pBuffer=e85ae000
4353490 12-14 14:30:56.550  3310 21028 D AmlogicVideoDecoderAwesome: input emptebufferdone p

echo 0x4000000 > /sys/module/amvideo/parameters/debug_flag


SWPL-3099 {Dolby Certification}Local playback,AVsync test failed.The latency is about +200ms+,audio is slower.3/3,T962/T962X exists
	---fixed
SWPL-2109 {Franklin P Dolby vision certification}It will frozen when play the source in HDR10/Adaptive_Streaming_Tests/TS/Combined and SDR/Adaptive_Streaming_Tests/HEVC/TS/Combined and AVC/MP4/Combined：3/3.Comparison results:T962E is normal.
	---fixed
SWPL-2101 {Franklin P Dolby vision certification}{AV}It will keep low resolution playback when play the source in /Test_Vectors/SDR/Adaptive_Streaming_Tests/AVC/23976/TS/combined.Frequency：5/5.Comparison results:T962E Android P is normal.
	---fixed
SWPL-1656 {Dolby Vision certification}{AV}It will exit to home or display Unsupport media when play SDR MP4 source in Test_Vectors/SDR/Adaptive_Streaming_Tests of Dolby vision certification.Frequency：5/5.Comparison results:No need.
	---fixed
SWPL-2508 {T962E Dolby vision certification}{AV}combined_ves_graffiti_50_hdr10__dvh1_st can't play.The other can be played normal source will black screen after play it.mp4.Frequency：5/5.Comparison results:Franklin P doesn't have this issue.
	---ongoing
SWPL-1174 {Dolby vision certification}{AV}The screen is frozen when play the source in Longevity_Tests/ folder;Frequency：3/3;Comparison results:No need
	---ongoing，使用辉哥提供的patch，t962e煲机2次，u212煲机1次没有复现，准备u212再煲机一次
	

绿屏
[0xff6388cc]=0x2aa0aaaa DMC_VPU_SEC_WRITE_CTRL
[0xff6388c8]=0x6aaabaa5 DMC_VPU_SEC_READ_CTRL
非绿屏
[0xff6388cc]=0x55555555 DMC_VPU_SEC_WRITE_CTRL
[0xff6388c8]=0xffffffff DMC_VPU_SEC_READ_CTRL

undefine dv profiel hevc 第二个
mov_read_dvcc:-438259320                                                       1                                                                          
,3g2,mj2 @ 0xe5e50000] profile error:127

mp42isomdby1 mp42isomdby1


Line 925: 12-28 21:52:01.727  9617 11094 D AmlogicVideoDecoderAwesome:   		  0# Out PTS: 0..vf.fd=0, mOutBufferNo=0, frame_num=0
Line 1167: 12-28 21:52:01.835  9617 11094 D AmlogicVideoDecoderAwesome:   		  0# Out PTS: 41708..vf.fd=0, mOutBufferNo=1, frame_num=1
	
Line 3960: 12-28 21:52:05.762  9617 11094 D AmlogicVideoDecoderAwesome:   		  0# Out PTS: 31281281..vf.fd=0, mOutBufferNo=91, frame_num=0
Line 4057: 12-28 21:52:05.874  9617 11094 D AmlogicVideoDecoderAwesome:   		  0# Out PTS: 31322989..vf.fd=0, mOutBufferNo=92, frame_num=1

echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
echo 0x0f > /sys/module/amvideo/parameters/video_dbg_vf
echo 1,1,1 > /sys/kernel/debug/video/pts_log_enable

1）如果只想看是否有drop的话，设置下面的节点，直接看kernel的log就可以了
echo 1,1,1 > /sys/kernel/debug/video/pts_log_enable
2）如果想看drop的具体情况，开始前输入
echo 0 > /proc/sys/kernel/printk 
dmesg -c > /dev/null
echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
结束时使用dmesg > kernel.log保存即可
如果播放的时间比较长的话，还要打上这个patch，http://scgit.amlogic.com:8080/#/c/55892/

echo 0 > /sys/module/amvdec_h265/parameters/fast_output_enable

while true;  do cat /sys/kernel/debug/vdec_profile/event; done &


sed -n 's/.*CONSUME timestampNs \(.*\), nowUs.*/\1/p' 20190214_02-15-54_logcat_15.log > 20190214_02-15-54_logcat_15-rendertime.log
sed -n 's/.*nowUs \(.*\), delta.*, delta_media.*/\1/p' 20190214_02-15-54_logcat_15.log > 20190214_02-15-54_logcat_15-rendernow.log
sed -n 's/.*mediatimeus:\(.*\),.*, render.*/\1/p' 20190214_02-15-54_logcat_15.log > 20190214_02-15-54_logcat_15-rendderpts.log
sed -n 's/.*mediatimeus:.*,\(.*\), render.*/\1/p' 20190214_02-15-54_logcat_15.log > 20190214_02-15-54_logcat_15-renderkpts.log
grep -rnI "Out PTS" 20190214_02-15-54_logcat_15.log > 20190214_02-15-54_logcat_15-omxoutpts.log
sed -n 's/.*mediatimeus:.*, render=\(.*\)/\1/p' 20190214_02-15-54_logcat_15.log >  20190214_02-15-54_logcat_15-render.log

sed -n 's/\[\(.*\)\].*set_omx_pts.*/\1/p'  k_15 >  k_15-kernel-setomx-time.log
sed -n 's/.*tmp_pts:\(.*\), set_from_hw.*/\1/p'  k_15 >  k_15-kernel-pts.log

sed -n 's/.*\[\(.*\)\] vpts.*/\1/p' k_14  > k_14-display-time.log
sed -n 's/.*pts=0x\(.*\), scr.*/\1/p' 5-kernel.log  > 5-kernel.log-display-pts.log
awk '{print strtonum("0x"$0)}' 5-kernel.log-display-pts.log > 5-kernel.log-display-pts.log-10.log
sed -n 's/.*ptstrace=\(.*\)/\1/p' k_14  > k_14-display-ptstrace.log

After first frame rended, system time(pcr) is changed to "current_vpts-VIDEO_HOLD_THRESHOLD" and trigged to continue increass even though audio have not started.
In this case, after first frame rended, and if video input buffer is enough and new frame is decoded after "VIDEO_HOLD_THRESHOLD" seconds, video
will be rended through comparing system time and video pts, not wait audio to sync. Then when audio started, it will resync again.
All is lead by system time(pcr) is changed by first frame rended, not by audio start.

Now for video peek in tunnel mode, after first frame peeked, we will not change systime time and not enable to increass system time(pcr) until audio start.
That is video will wait for audio for to sync after first frame.


echo 1 > /sys/module/decoder_common/parameters/dec_time_stat_reset

echo 1 > /sys/module/decoder_common/parameters/dec_time_stat_flag
sleep 1s
cat /sys/kernel/debug/vdec_profile/time_stat

media.audio.hal.debug

测试前输入
setprop media.omx.log_levels 255
echo 0 > /proc/sys/kernel/printk
echo 0x400000 > /sys/module/amvideo/parameters/debug_flag
echo 1,1,1 > /sys/kernel/debug/video/pts_log_enable
echo 0x0f > /sys/module/amvideo/parameters/video_dbg_vf
logcat > kadun.log &

出现卡顿后，保存kernel log
dmesg > kernel.log

出现卡顿前输入
dmesg -c > /dev/null
出现卡顿后输入
dmesg > kerne-2.log


Please set "setprop media.omx.dw 4" and to confirm the follow stream problem
[8KH265_Main 10@L6.2@Main_7680x4320_30fps_36Mbps_8bit_AAC2ch]video_ultrahd_demo_video_for_8k_oled_tv-IRSVsCBtgnk.ts
"0:00:00-0:00:11，0:00:50-0:01:10" not smooth
code: http://jenkins-sh.amlogic.com:8080/job/android/job/Android_P/job/Android_P_Mainline_PATCHBUILD2/2216/


youtobe
macro flowers

SWPL-3695 [Ampere P]{Netflix}during play h265 video random picture obviously not smooth；（5/5times）;contrast:no 
	---fixed
SWPL-3377 {A/V} X301 P Playing 8K VP9/H265, The first second screen after the broadcast or seek will not be smooth Probability: 10/10 of the times comparison: No need to compare 
	---fixed
SWPL-3520 {A/V} X301 P The video is not smooth when playing port of 8K H265 below 30fps Probability: 10/10 of the times comparison: No need to compare 	
	---ongoing，还有一个30fps的8k视频QA反馈有不流畅，但实际toggle显示是ok的
SWPL-2002 {NTS}Automated Test PROF-001-TC14 Step #1 Failed: Load the JavaScript Test, (Verify HDR Video Profiles - Dolby Vision - 4K) to be executed on the device and wait for completion. 
	---ongoing，转liushen处理
SWPL-3591 {A/V} X301 P playing "Samsung.HDR.4K.DEMO_Chasing.the.Light.ts", Probabilistic caron once after seek Probability: 7/10 of the times comparison: Einstein P is normal 
	---ongoing,准备看
SWPL-3631 [Ampere P]during play youtube video,use bt voice many times pitcture stop audio output normal；（3times/1day）;contrast:no
	---ongoing，上周四没有复现，需要再煲机
	
11110058 01-26 19:28:19.097 I/NU-LiveSession( 3009): bandwidth estimated at 444.17 kbps, stable 0, shortTermBps 80.59 kbps
11110059 01-26 19:28:19.097 I/NU-LiveSession( 3009): changeConfiguration: timeUs=-1 us, bwIndex=0, pickTrack=0
11110060 01-26 19:28:19.097 I/NU-LiveSession( 3009): #### Starting Bandwidth Switch: 1 => 0
11110061 01-26 19:28:19.097 I/NU-LiveSession( 3009): pausing fetcher-1, threshold=0.00
11110077 01-26 19:28:19.898 I/NU-LiveSession( 3009): Switch/Reconfig in progress, defer buffer polling
11110099 01-26 19:28:20.006 I/NU-LiveSession( 3009): [fetcher-0] startAsync: startTimeUs 95606606333 mLastSeekTimeUs 0 segmentStartTimeUs 42504811 seekMode 1
guessed wrong seg number: diff -95426077689 out of [-6000000, 0]
bytesRead 48128 took 12.51 seconds - abnormal bandwidth dip

mnt/fileroot/shuanglong.wang/p-amlogic-mainline/frameworks/base
core/java/android/webkit/URLUtil.java:30:public final class URLUtil {


dd if=es_aml_secure.h264 skip=40960 of=seek25M.h264

am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80015468?source=99'


while true; do  cat /sys/class/codec_mm/codec_mm_dump;free; dumpsys meminfo; done &


adb shell setprop libc.debug.malloc.program app_process
adb shell setprop libc.debug.malloc.options backtrace
看内存踩踏
1. 用usrdebug版本：setprop libc.debug.malloc.options "backtrace guard"
2. setprop libc.debug.malloc.program com.google.android.youtube.tv
3. kill掉mediaserver进程

am start -a com.google.android.exoplayer.demo.action.VIEW -d file:///storage/2940-157B/swpl-3591/Samsung.HDR.4K.DEMO_Chasing.the.Light.ts

am start -a com.google.android.exoplayer.demo.action.VIEW -d http://10.68.11.62:8800/4kvp9/%5b4KVP9_60fps_25.7Mbps_8bit%5dbbb_sunflower_2160p_60fps_normal.webm


nts trace patch
	http://scgit.amlogic.com:8080/#/c/61397/
	http://scgit.amlogic.com:8080/#/c/61398/

nts debug kernel
	http://scgit.amlogic.com:8080/#/c/55892
	http://scgit.amlogic.com:8080/#/c/62934
	http://scgit.amlogic.com:8080/63020
	
	trace:
	http://scgit.amlogic.com:8080/63070
	http://scgit.amlogic.com:8080/#/c/63095

打trace的版本
http://10.18.11.97/shanghai/image/android/Android-P//Android_TV/patchbuild/2019-03-13/franklin-userdebug-android32-kernel64-GTVS-3238/
加log的的版本
http://10.18.11.97/shanghai/image/android/Android-P//Android_TV/patchbuild/2019-03-13/franklin-userdebug-android32-kernel64-GTVS-3228/  + libstagefright.so

http://jenkins-sh.amlogic.com:8080/job/android/job/Android_P/job/Android_P_Mainline_PATCHBUILD2/3245/


/vendor/build.prop 文件，把 vendor.media.sync.limit=1，这个先注释掉，重启下压测试试

这个是注释掉的原因
https://partnertools.nrd.netflix.com/nts/#testhistory?markerSetId=136803517


sed -n 's/.*\[\(.*\)\].*set_omx_pts.*/\1/p' setomxpts.log > setomxpts-kernel-time.log
sed -n 's/.*tmp_pts:\(.*\), set_from_hw.*/\1/p' setomxpts.log > setomxpts-kernel-pts.log


sed -n 's/.*\[\(.*\)\] vpts.*/\1/p' 0507-k_15.log  > 0507-k_15-display-time.log
sed -n 's/.*pts=0x\(.*\), scr.*/\1/p' k_0  > k_0-display-pts.log
awk '{print strtonum("0x"$0)}' k_0-display-pts.log > k_0-display-pts.10.log
sed -n 's/.*ptstrace=\(.*\)/\1/p' 0507-k_15.log  > 0507-k_15-display-ptstrace.log


1.  reset, 关掉selinux
2. 保存kernel log, dmesg > /data/kernel.log
3. setprop media.omx.log_levels 255 ; logcat > /data/logcat.log &
4.开始测试，观察下pcr，while do cat /sys/class/tsync/pts_pcrscr; sleep 0.5; done


echo 3 > /sys/module/vfm/parameters/vfm_debug_flag



media.omx.videopeek
/sys/module/amvdec_h265/parameters/force_bypass_dvenl


file:///D:/work/prox.pac
http://it-wiki.amlogic.com/IT_knowledge/How_to_setup_proxy


mount -o remount,rw -t ext4 /dev/root /
mount -w -o remount /dev/block/system /system
mount -o remount,rw /vendor
 
 整包编译
1) source build/envsetup.sh
2) lunch r33a8-userdebug
3) make otapackage -j8



1. TV-4097 [MIUI][R31AD][T960X][9.0][video][NTS_other]SingIn Netflix,video preview playback error
--播放一会就停止，ott是直接不播放，需要确认下是否合理
2. TV-4017 [R31AD][T960X][9.0][NTS]: In Case Play-253-TC5，the time of FF/FB more than 250ms. 
---resume的慢，从log上看解码的不慢，像是app同步的有点慢，需要进一步确认
3. TV-4011 [MIUI][R31AD][T960X][9.0][NTS]Run Peanut test，video is not smooth after overnight test
--煲机问题，需要现场和log分析
4. TV-3778 [MIUI][R31AD][T960X][9.0][NTS][DRS]: Test DRS-AL1-25FPS-HEAAC-DWN Step #1 Failed.ERROR: Frame Drop and Freeze Frame deteced
--高帧率的patch问题
5. TV-3670 [MIUI][R33A8][T950X][9.0][NTS]Run case PLAY-257-TC2 step#8 fail,The video play fast forward after click OK
--closed 需要确认，source版本已无些问题
6. TV-3621[MIUI][R33A8][T950X][9.0][NTS][Video] PROF-004-TC2 fail，nrdp.device.capability.videoProfiles contains unexpected profile: hevc-hdr-main10-L30-dash-cenc-prk.
--closed profile没有，目前看dpi-profile里是有的
7. TV-3560 [MIUI][R31AD][T960X][9.0][NTS][PlaybackQuality]: Test PLAY-AL1-23FPS-HEAAC Step #1 Failed.
--patch不全，需要新版本再确认下


DRS-HDR10-60FPS-HEAAC-UP  2次fail drop 1
PLAY-HEVC-60FPS-HEAAC     2次fail frezee drop
DRS-HDR10-59FPS-HEAAC-DWN 

0423
1. 高帧率timestamp不准确的问题，相关高帧率优化的patch没有合进去，新版本已经确认无些问题了
2. PLAY-257-TC2 step#8 fail,The video play fast forward after click OK
    --- source版本已无此问题，需要QA确认
3. Play-253-TC5，the time of FF/FB more than 250ms.
   ----从trace上看，目前大概280ms的时间，需要QA再确认下
4.PLAY-001-TC4 artifacts
   ----dump流确认流就是这样的，不用care
   
0424   
TV-3670 [MIUI][R33A8][T950X][9.0][NTS]Run case PLAY-257-TC2 step#8 fail,The video play fast forward after click OK
   --这个问题应该复现不到
TV-4017 [R31AD][T960X][9.0][NTS]: In Case Play-253-TC5，the time of FF/FB more than 250ms.
  --这个从trace上看大概是280ms，没有超过500ms，帮忙再确认下，如果有问题，帮忙抓个trace
  
关掉蓝牙：
service call bluetooth_manager 8
pm disable com.android.bluetooth
mount -w -o remount /dev/block/vendor /vendor
rm vendor/etc/permissions/android.hardware.bluetooth*
  
1. play 60
Log ID:137267386


DRS-HDR10-50FPS-HEAAC-UP	Fail  137265270  
512x384	Fail  137265473
DRS-HDR10-60FPS-HEAAC-UP	Fail  137265355

PLAY-HDR10-59FPS-HEAAC		Fail  137263103
PLAY-HDR10-60FPS-HEAAC		Fail  137263286
PLAY-HEVC-29FPS-HEAAC		Fail  137264058	  211ms frezee引起的drop，应该是低概率的
PLAY-HEVC-59FPS-HEAAC		Fail  137264407

SYNC-AL1-24FPS-DDP51	Fail	137242504   diff了16ms
SYNC-AL1-29FPS-DDP2CH	Fail	137243656   After Track Change， 超过165ms， out of range
SYNC-AL1-30FPS-HEAAC	Fail	137244972   After Audio Track Switch，超过165ms， 1/2
SYNC-HDR10-23FPS-HEAAC	Fail	137245552   After Video Seek 
SYNC-HDR10-25FPS-HEAAC	Fail	137246675   After Video Seek 
SYNC-HDR10-29FPS-HEAAC	Fail	137247351   After Video Seek 
SYNC-HDR10-60FPS-HEAAC	Fail	137250520   After Video Seek , 1/2
SYNC-HEVC-25FPS-HEAAC	Fail	137252576   After Video Seek
SYNC-HEVC-30FPS-HEAAC	Fail	137254587   After Video Seek
SYNC-HEVC-50FPS-HEAAC	Fail	137255272   After Video Seek,环境有问题一次
SYNC-HEVC-59FPS-HEAAC	Fail	137256375   After Video Seek  1/1


58      echo rv 0x1d93 > sys/class/amvecm/reg 
59      echo wv 0x1d93 0xf8d7 > sys/class/amvecm/reg 
60      echo wv 0x1d93 0xf8d3 > sys/class/amvecm/reg 
61      cd sys
62      cd class/
63      cd amvecm
64      echo rv 1de1 > reg
65      echo rv 1de2 > reg
66      echo wv 1de2 0x20000000 > reg
67      echo wv 1de1 0x20000000 > reg
68      echo rv 1d93 > reg
69      echo wv 1de2 0x0 > reg
70      echo wv 1
71      echo wv 1d93 0xf8d0 > reg
72      pk8
73      clear

14      cat frame_width 
15      cd ..
16      cd amvecm
17      echo rv 1
18      echo rv 1ae0 > reg
19      echo 0 > /sys/module/amvideo/parameters/force_no_compress 



http://scgit.amlogic.com:8080/#/c/61695/   Add cap_nice and set sched policy to FIFO
http://scgit.amlogic.com:8080/#/c/62551/    add a sysfs to get vframe ready count
http://scgit.amlogic.com:8080/#/c/62620/ Start pcrscr only when 2 frames ready Adjust
http://scgit.amlogic.com:8080/#/c/62600/  The pcrscr start early than video pts.

http://scgit.amlogic.com/kernel/common/commit/?h=amlogic-4.9-dev_9.2.1811_21&id=022737d113a3d961da9257d09abab315f305f1a9
http://scgit.amlogic.com/kernel/common/commit/?h=amlogic-4.9-dev_9.2.1811_21&id=f11cd90319faacce9e949a87020823c66191b461
http://scgit.amlogic.com/kernel/common/commit/?h=amlogic-4.9-dev_9.2.1811_21&id=e76cceeb8f9fa36449768954a2c7fa515250f6a0
http://scgit.amlogic.com/platform/hardware/amlogic/media_modules/commit/?h=amlogic-4.9-dev_9.2.1811_21&id=84ced1ae65628216fd8d81807eb3fe5a5d36daa2
http://scgit.amlogic.com/vendor/amlogic/prebuilt/libmediadrm/commit/?h=p-amlogic-mainline_9.2.1811_21&id=aa83fd565a4684cdfa70743e31b50f4f6af8fac5
http://scgit.amlogic.com/vendor/widevine/commit/?h=p-amlogic_9.2.1811_21&id=4bb4ccc849203ea6baa05f56a20c794d516e3b10
http://scgit.amlogic.com/device/amlogic-o/commit/?h=p-amlogic-mainline_9.2.1811_21&id=93eb27ec826ba203a426f85ac295e370864e6957
http://scgit.amlogic.com/device/amlogic-o/commit/?h=p-amlogic-mainline_9.2.1811_21&id=f45254a60550f817cbb7e898e8693146708a2810
http://scgit.amlogic.com/platform/hardware/amlogic/audio/commit/?h=p-amlogic-mainline_9.2.1811_21&id=3eea15d6d4c0764cb1b628ceeb286f2b26f67af8



35243.07299999893	1


v50
 137450102 frezee drop
 137450019 audio tone
 137449706 audio tone
 137449640 frezee drop
 137449581 audio tone
 137448846 frezee drop
 137447899 audio tone
 137447816 frezee drop
 137447725 frezee drop
 137447275 frezee drop
 137446943 frezee drop
 137446811 frezee drop
 137446761 audio tone
 137446712 frezee drop
 137446490 audio tone
 137446405 frezee drop
 137446342 audio tone
 137446280 audio tone
 137445918 audio tone

 
 
1.HeapTaskDaemon, Storaged, HWBinder, IpClent.eth0, DOLBY_MS12
2. 执行GC操作的时候，任何线程的任何操作都会需要暂停，等待GC操作完成之后，其他操作才能够继续运行
-Memory Churn内存抖动，内存抖动是因为大量的对象被创建又在短时间内马上被释放。
-瞬间产生大量的对象会严重占用Young Generation的内存区域，当达到阀值，剩余空间不够的时候，也会触发GC。
即使每次分配的对象占用了很少的内存，但是他们叠加在一起会增加Heap的压力，从而触发更多其他类型的GC。
这个操作有可能会影响到帧率，并使得用户感知到性能问题




#guotao
top -d 10


setprop media.omx.out_buffer1 8


echo 0x0002 > /sys/module/amvdec_mmpeg12/parameters/debug_enable

OTT-3857
[Hisense][A311D][9.0][Feedback][HDMI]: NT72673A311D-3323 A311D data abnormality causes MEMC to fail
1.替换老版本libamffmpegadatper.so与原来的效果一样，不会出现underflow
2.加大输出omx buffer num到8，有效果，不会出现underflow
3.加大buffer情况下，只出现两场drop，原因是pts回调，mpeg12只用I帧的pts，其它的pts是计算出来。ffmpeg出来的pts有不少NA


no reproduce -TV-4476[MIUI][R31AD][T960X][9.0][Video]: Play 【(1920x1080)Alisan.Trailer-80Mbps.mpg（PCM）】Video is not smooth, audio video is out of sync(100% source NG)
---TV-4484[MIUI][R31AD][T960X][9.0][Video]: Play【[4KVP9_50fps_Mbps_8bit]Wetek-Astra_12343_H_30000-Insight UHD Pearl TV.webm】Do the seek action, appear mosaic(100% source NG)
	-----The stream cannot seek, should be abnormal stream. VLC or ffplay play will occur mosaic after play several second.
hwc -TV-5820[MIUI][R33A8][T950X][9.0][AML-18][Video]:Play some HDR-H265_60fps source black screens, but the sound is normal.(100% Sources NG, R311 ok)
TV-5811[SWPL-8481][MIUI][R31AD][T960X][9.0][AML-26][Video]：The 2k_2048x1440_mpeg4_60fps.mp4 video cannot be loaded and the sound is normal.(100% R311 NG) 
TV-4466[SWPL-2357][MIUI][R31AD][T960X][9.0][Video]: Play 【134108-xvid-mp3-704x340-6k-gmc-bf-6m.avi】Serious mosaic(100% source NG) 

am start -n com.android.gallery3d/.app.MovieActivity -d file:///sdcard/Download/tv4484.webm


echo 0x8000000 > /sys/module/amvdec_vp9/parameters/debug 
echo 4 > /sys/module/amvdec_vp9/parameters/double_write_mode 


/sys/class/thermal/thermal_zone0/mode
/sys/class/mpgpu/scale_mode

播放前设置
setprop media.omx.log_levels 255
logcat -c; logcat > logcat.log &
出现问题后下面指令多执行几次
debuggerd $(busybox pidof mediaserver) >> ms.log
debuggerd $(busybox pidof surfaceflinger) >> sf.log
debuggerd $(busybox pidof media.codec) >> mc.log

由于不是太好复现，log就多抓些，kernel 和logcat分开抓吧，logcat重定向到falsh或者u盘都可以,kernel用串口终端保存就ok
setprop media.omx.log_levels 255
while true; do dumpsys meminfo; sleep 10; done &
logcat -v threadtime >logcat.log

1.setprop debug.stagefright.omx-debug 5; setprop media.omx.log_levels 255
2. 用usrdebug版本：setprop libc.debug.malloc.options "backtrace guard leak_track verify_pointers"
3. setprop libc.debug.malloc.program media.codec
4. kill掉mediaserver进程,复现问题，抓logcat
   kill $(busybox pidof media.codec)
   logcat -v threadtime >logcat.log
   
从log上看有两个问题，
1. mediacodec crash问题，像是发生内存踩踏或越界，这个还需要debug

2.发生ANR
像是卡在player的reset上，从logcat上看是player的seek卡住导致了ANR，需要小米来看
  native: #00 pc 00053f0c  /system/lib/libc.so (__ioctl+8)
  native: #01 pc 00021c11  /system/lib/libc.so (ioctl+36)
  native: #02 pc 0003d5f7  /system/lib/libbinder.so (android::IPCThreadState::talkWithDriver(bool)+206)
  native: #03 pc 0003e003  /system/lib/libbinder.so (android::IPCThreadState::waitForResponse(android::Parcel*, int*)+26)
  native: #04 pc 0003725d  /system/lib/libbinder.so (android::BpBinder::transact(unsigned int, android::Parcel const&, android::Parcel*, unsigned int)+36)
  native: #05 pc 00036171  /system/lib/libmedia.so (android::BpMediaPlayer::reset()+60)
  native: #06 pc 0002fd59  /system/lib/libmedia.so (android::MediaPlayer::reset_l()+36)
  native: #07 pc 0002fde3  /system/lib/libmedia.so (android::MediaPlayer::reset()+30)
  native: #08 pc 00030d55  /system/lib/libmedia_jni.so (android_media_MediaPlayer_reset(_JNIEnv*, _jobject*)+76)
  at android.media.MediaPlayer._reset(Native method)
  at android.media.MediaPlayer.reset(MediaPlayer.java:2188)
  at com.miui.videoplayer.model.OriginMediaPlayer.reset(SourceFile:93)
  at com.miui.videoplayer.media.DuoKanPlayer.reset(SourceFile:495)
  at com.miui.videoplayer.videoview.DuoKanVideoView.release(SourceFile:457)
  at com.miui.videoplayer.videoview.DuoKanVideoView.close(SourceFile:728)
  at com.mitv.videoplayer.localplay.LocalVideoView.close(SourceFile:47)



setprop libc.debug.malloc.options "backtrace guard"
setprop libc.debug.malloc.program "hw/android.hardware.media.omx@1.0-service"
killall media.codec

串口输入设置 setprop media.omx.log_levels 255; setprop debug.stagefright.omx-debug 5
再播放抓logcat即可，还使用昨天libstagefright下的patch
出现crash即可

setprop libc.debug.malloc 1
setprop libc.debug.malloc.program "mediaserver"
setprop libc.debug.malloc.options "backtrace"
killall mediaserver
sleep 1
dumpsys -t 200 media.player -m >a1.log
sleep 3
dumpsys -t 200 media.player -m > a2.log




#extractor 
setprop libc.debug.malloc.options "backtrace guard"
setprop libc.debug.malloc.program aextractor
killms;killmc;killme;killmc

01-01 06:18:50.584 14310 14353 E malloc_debug: InternalFree 0xb02e79d0                                                                                                                                   
01-01 06:18:50.585 14310 14353 I AmFFmpegExtractor: [wsl]buf[22]11=187, 0xb0284e30                                                                       
01-01 06:18:50.585 14310 14353 I AmFFmpegExtractor: [wsl]buf[22]22=50 0xb0284e30                                                                         
01-01 06:18:50.585 14310 14353 E malloc_debug: InternalFree 0xb0284e30                                                                                
01-01 06:18:50.585 14310 14353 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***                              
01-01 06:18:50.585 14310 14353 E malloc_debug: +++ ALLOCATION 0xb0284e30 SIZE 1024 HAS A CORRUPTED REAR GUARD                               
01-01 06:18:50.586 14310 14353 E malloc_debug:   allocation[1026] = 0x32 (expected 0xbb)                      
01-01 06:18:50.586 14310 14353 E malloc_debug: Backtrace at time of failure:                                  
01-01 06:18:50.587 14310 14353 E malloc_debug:           #00  pc 0000df7c  /system/lib/libamffmpegadapter.so (android::AmFFmpegSource::read(android::MediaBufferBase**, android::MediaTrack::ReadOptions const
01-01 06:18:50.587 14310 14353 E malloc_debug:           #01  pc 0003acba  /system/lib/libmedia.so (android::BnMediaSource::onTransact(unsigned int, android::Parcel const&, android::Parcel*, unsigned int)+5
01-01 06:18:50.587 14310 14353 E malloc_debug:           #02  pc 000361ce  /system/lib/libbinder.so (android::BBinder::transact(unsigned int, android::Parcel const&, android::Parcel*, unsigned int)+69)
01-01 06:18:50.587 14310 14353 E malloc_debug:           #03  pc 0003da16  /system/lib/libbinder.so (android::IPCThreadState::executeCommand(int)+409)
01-01 06:18:50.587 14310 14353 E malloc_debug:           #04  pc 0003d7a2  /system/lib/libbinder.so (android::IPCThreadState::getAndExecuteCommand()+105)
01-01 06:18:50.587 14310 14353 E malloc_debug:           #05  pc 0003dcca  /system/lib/libbinder.so (android::IPCThreadState::joinThreadPool(bool)+37)
01-01 06:18:50.587 14310 14353 E malloc_debug:           #06  pc 000546fc  /system/lib/libbinder.so                                                                                                           
01-01 06:18:50.587 14310 14353 E malloc_debug:           #07  pc 0000c146  /system/lib/libutils.so (android::Thread::_threadLoop(void*)+165)                                                                  
01-01 06:18:50.587 14310 14353 E malloc_debug:           #08  pc 00063c14  /system/lib/libc.so                                                                                                           
01-01 06:18:50.587 14310 14353 E malloc_debug:           #09  pc 0001e064  /system/lib/libc.so                                                        
01-01 06:18:50.587 14310 14353 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***                                           
01-01 06:18:50.589 14310 14353 E malloc_debug: InternalFree 0xb0299730                                                                                
01-01 06:18:50.590 14310 14353 E malloc_debug: InternalFree 0xb02fc3f0


#mediacodec
setprop libc.debug.malloc.options "backtrace guard"
setprop libc.debug.malloc.program "mediaserver" or none
killall media.codec

01-01 06:40:12.165  5025  5875 I MediaCodec: [wsl]buf[22]11=187,0xaedd9aa0
01-01 06:40:12.165  5025  5875 I MediaCodec: [wsl]buf[22]22=50,0xaedd9aa0
01-01 06:40:12.165  5025  5875 E malloc_debug: InternalFree 0xaedd9aa0
01-01 06:40:12.165  5025  5875 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
01-01 06:40:12.165  5025  5875 E malloc_debug: +++ ALLOCATION 0xaedd9aa0 SIZE 20 HAS A CORRUPTED REAR GUARD
01-01 06:40:12.165  5025  5875 E malloc_debug:   allocation[22] = 0x32 (expected 0xbb)
01-01 06:40:12.165  5025  5875 E malloc_debug: Backtrace at time of failure:
01-01 06:40:12.166  5025  5875 E malloc_debug:           #00  pc 00085f16  /system/lib/libstagefright.so (android::MediaCodec::queueInputBuffer(unsigned int, unsigned int, unsigned int, long long, unsigned
01-01 06:40:12.166  5025  5875 E malloc_debug:           #01  pc 000536d6  /system/lib/libamnuplayer.so (android::AmNuPlayer::Decoder::onInputBufferFetched(android::sp<android::AMessage> const&)+1341)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #02  pc 00052d72  /system/lib/libamnuplayer.so (android::AmNuPlayer::Decoder::doRequestBuffers()+201)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #03  pc 00054334  /system/lib/libamnuplayer.so (android::AmNuPlayer::DecoderBase::onRequestInputBuffers()+27)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #04  pc 00050d6c  /system/lib/libamnuplayer.so (android::AmNuPlayer::Decoder::onMessageReceived(android::sp<android::AMessage> const&)+439)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #05  pc 0000d428  /system/lib/libstagefright_foundation.so (android::AHandler::deliverMessage(android::sp<android::AMessage> const&)+23)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #06  pc 0000fd18  /system/lib/libstagefright_foundation.so (android::AMessage::deliver()+59)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #07  pc 0000e100  /system/lib/libstagefright_foundation.so (android::ALooper::loop()+475)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #08  pc 0000c1be  /system/lib/libutils.so (android::Thread::_threadLoop(void*)+285)
01-01 06:40:12.166  5025  5875 E malloc_debug:           #09  pc 00063c14  /system/lib/libc.so
01-01 06:40:12.166  5025  5875 E malloc_debug:           #10  pc 0001e064  /system/lib/libc.so
01-01 06:40:12.166  5025  5875 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
01-01 06:40:12.167  5749  5749 E malloc_debug: InternalFree 0xaa397570
01-01 06:40:12.167  5025  5875 I MediaCodec: [wsl]buf[22]33=20        
01-01 06:40:12.168  5025  5878 E malloc_debug: InternalFree 0xaea58e90
01-01 06:40:12.169  5749  5749 E malloc_debug: InternalFree 0xaa397570
01-01 06:40:12.169  5749  5749 E malloc_debug: InternalFree 0xaa397570

#amnuplayer
setprop libc.debug.malloc.options "backtrace guard"
setprop libc.debug.malloc.program "mediaserver"
killall mediaserver
01-01 01:00:56.153  8559  8770 E malloc_debug: InternalFree 0xa7a04430
01-01 01:00:56.153  8559  8770 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
01-01 01:00:56.153  8559  8770 E malloc_debug: +++ ALLOCATION 0xa7a04430 SIZE 1024 HAS A CORRUPTED REAR GUARD
01-01 01:00:56.153  8559  8770 E malloc_debug:   allocation[1026] = 0x32 (expected 0xbb)
01-01 01:00:56.153  8559  8770 E malloc_debug: Backtrace at time of failure:
01-01 01:00:56.153  8559  8767 E malloc_debug: InternalFree 0xa7a55a30
01-01 01:00:56.154  8559  8767 E malloc_debug: InternalFree 0xa7a41e30
01-01 01:00:56.154  8559  8769 E malloc_debug: InternalFree 0xa7a55d30
01-01 01:00:56.154  8559  8769 E malloc_debug: InternalFree 0xa7a421b0
01-01 01:00:56.155  8559  8770 E malloc_debug:           #00  pc 00041b50  /system/lib/libamnuplayer.so (android::AmNuPlayer::GenericSource::readBuffer(android::media_track_type, long long, android::MediaTr
01-01 01:00:56.155  8559  8770 E malloc_debug:           #01  pc 00042566  /system/lib/libamnuplayer.so (android::AmNuPlayer::GenericSource::onReadBuffer(android::sp<android::AMessage> const&)+81)
01-01 01:00:56.155  8559  8770 E malloc_debug:           #02  pc 00041118  /system/lib/libamnuplayer.so (android::AmNuPlayer::GenericSource::onMessageReceived(android::sp<android::AMessage> const&)+119)
01-01 01:00:56.155  8559  8770 E malloc_debug:           #03  pc 0000d428  /system/lib/libstagefright_foundation.so (android::AHandler::deliverMessage(android::sp<android::AMessage> const&)+23)
01-01 01:00:56.155  8559  8770 E malloc_debug:           #04  pc 0000fd18  /system/lib/libstagefright_foundation.so (android::AMessage::deliver()+59)
01-01 01:00:56.155  8559  8770 E malloc_debug:           #05  pc 0000e100  /system/lib/libstagefright_foundation.so (android::ALooper::loop()+475)
01-01 01:00:56.155  8559  8770 E malloc_debug:           #06  pc 0000c1be  /system/lib/libutils.so (android::Thread::_threadLoop(void*)+285)
01-01 01:00:56.155  8559  8770 E malloc_debug:           #07  pc 00063c14  /system/lib/libc.so
01-01 01:00:56.155  8559  8770 E malloc_debug:           #08  pc 0001e064  /system/lib/libc.so
01-01 01:00:56.155  8559  8770 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***

#omx
 
setprop libc.debug.malloc.options "backtrace guard"
setprop libc.debug.malloc.program "hw/android.hardware.media.omx@1.0-service"
killall media.codec

01-01 01:28:15.354 13053 13247 I AmlogicVideoDecoderAwesome: [wsl]buf[22]22=50 0xa6883a30
01-01 01:28:15.354 13053 13247 E malloc_debug: InternalFree 0xa6883a30
01-01 01:28:15.354 13053 13247 E malloc_debug: *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
01-01 01:28:15.354 13053 13247 E malloc_debug: +++ ALLOCATION 0xa6883a30 SIZE 1024 HAS A CORRUPTED REAR GUARD
01-01 01:28:15.355 13053 13247 E malloc_debug:   allocation[1026] = 0x32 (expected 0xbb)
01-01 01:28:15.355 13053 13130 E malloc_debug: InternalFree 0xa6364750
01-01 01:28:15.355 13053 13247 E malloc_debug: Backtrace at time of failure:
01-01 01:28:15.358 13053 13130 E malloc_debug: InternalFree 0xa6364810
01-01 01:28:15.358 13053 13130 E malloc_debug: InternalFree 0xa6364810
01-01 01:28:15.362 13053 13130 E malloc_debug: InternalFree 0xa6364870
01-01 01:28:15.372 13053 13247 E malloc_debug:           #00  pc 00014ac6  /vendor/lib/libOmxVideo.so (android::amlpeer::AmlogicVideoDecoder::doWriteBuffer()+85)
01-01 01:28:15.372 13053 13247 E malloc_debug:           #01  pc 0000262e  /vendor/lib/libomx_worker_peer_alt.so (android::WorkerPeer::runWorker()+293)
01-01 01:28:15.372 13053 13247 E malloc_debug:           #02  pc 00002492  /vendor/lib/libomx_worker_peer_alt.so (android::WorkerPeer::runWorkerStatic(void*)+37)
01-01 01:28:15.372 13053 13247 E malloc_debug:           #03  pc 00063c14  /system/lib/libc.so
01-01 01:28:15.372 13053 13247 E malloc_debug:           #04  pc 0001e064  /system/lib/libc.so


backtrace\_dump\_on\_exit

setprop libc.debug.malloc.options "backtrace guard leak_track"
setprop libc.debug.malloc.program aextractor
killall media.extractor
kill -47 $(busybox pidof media.extractor)

#内存泄露


VTS_01_1.VOB,
1.没声音及音频与视频不对的问题，需要小米从播放器同步方面去分析，从log上看流是回环流，应该播放器方面对这种pts回跳处理的问题
07-11 11:08:18.671  2681 31848 D AmlogicVideoDecoderAwesome: In PTS 79960000,	nFilledLen=29000, bufferHdr.pBuffer=ed742000
07-11 11:08:18.712  2681 31848 D AmlogicVideoDecoderAwesome: In PTS 80000000,	nFilledLen=57041, bufferHdr.pBuffer=ed742000
07-11 11:08:18.754  2681 31848 D AmlogicVideoDecoderAwesome: In PTS 0,	nFilledLen=20538, bufferHdr.pBuffer=ed742000
07-11 11:08:19.503  2681 31848 D AmlogicVideoDecoderAwesome: In PTS 1,	nFilledLen=9299, bufferHdr.pBuffer=ed842000
07-11 11:08:19.524  2681 31848 D AmlogicVideoDecoderAwesome: In PTS 40000,	nFilledLen=29000, bufferHdr.pBuffer=ed942000
07-11 11:08:19.964  2681 31831 W MiCore  : main audio output: buffer too late (-79926939 us): dropped
07-11 11:08:19.964  2681 31831 W MiCore  : main audio output: buffer too late (-79895220 us): dropped
07-11 11:08:19.964  2681 31831 W MiCore  : main audio output: buffer too late (-79863404 us): dropped
07-11 11:08:19.970  2681 31831 W MiCore  : main audio output: buffer too late (-79836818 us): dropped
07-11 11:08:19.970  2681 31831 W MiCore  : main audio output: buffer too late (-79805078 us): dropped
07-11 11:08:19.970  2681 31831 W MiCore  : main audio output: buffer too late (-79773204 us): dropped
07-11 11:08:19.970  2681 31831 W MiCore  : main audio output: buffer too late (-79741295 us): dropped
2.最后面卡住的问题，请先小米处理完上面的问题后再确认，从dump数据上看，输入数据没有了，decoder就没有解码输出的，可能上面的问题处理完后就没有这个卡住的问题了



0xebe3f1c0: 8100.00 KiB | 1920 (1920) x 1080 |    1 |        1 | 0xb00 | com.google.android.tvlauncher/com.google.android.tvlauncher.appsview.AppsViewActivity#0
0xebe3f280: 8100.00 KiB | 1920 (1920) x 1080 |    1 |        1 | 0xb00 | com.google.android.tvlauncher/com.google.android.tvlauncher.appsview.AppsViewActivity#0


echo null > /sys/class/display/mode
echo 0 >/sys/class/amhdmitx/amhdmitx0/frac_rate_policy (0=60hz, 1=59.94hz)
echo 2160p60hz > /sys/class/display/mode


1.copy到data目录，chmod +x scratch-logcat-toyb-59fps-kernel-all.sh 
2.执行脚本, ./scratch-logcat-toyb-59fps-kernel-all.sh 
3.播放复现问题，出现问题后，立刻推出播放，等待超过40s后，ctrl+c结束抓log
4.tar cvfz log.tar.gz  k_* logcat.log，把data目录生成的log.tar.gz发来


1.adapter的提交  divx不放到blacklist，这样extractor source不会有video source，会给player报805错
http://scgit.amlogic.com:8080/#/c/81328/

2.nts问题common提交
 1）app不连续drop时不更新omxpts
 2）check omxpts有一段时间不更新的逻辑修改，之前修改bug的时候改错了，现在又恢复回去
http://scgit.amlogic.com:8080/#/c/80847/

3. omx的so的提交，source之前merge的
scgit.amlogic.com:8080/#/c/81357/


[ 8517.093293] [set_omx_pts]tmp_pts:225225, set_from_hwc:1,frame_num=75, not_reset=0                  
[ 8517.114346] vpts = 0x37b83, c.dur=0xc83, n.pts=0x3873e, scr = 0x38a2e, pcr-pts-diff=376, ptstrace=2
[ 8517.126937] [set_omx_pts]tmp_pts:228228, set_from_hwc:1,frame_num=76, not_reset=0                  
[ 8517.147714] vpts = 0x3873e, c.dur=0xc83, n.pts=0x392f9, scr = 0x395e9, pcr-pts-diff=376, ptstrace=2
[ 8517.160098] [set_omx_pts]tmp_pts:231231, set_from_hwc:1,frame_num=77, not_reset=0      231231             
[ 8517.181085] vpts = 0x392f9, c.dur=0xc83, n.pts=0x39eb4, scr = 0x3a1a4, pcr-pts-diff=376, ptstrace=2
[ 8517.197752] omxpts is not update for a while,do not need compenstatete

repo init -u git://aml-code-master.amlogic.com/ref-o/platform/manifest.git -b q-fs-release -m google_partner_ref.xml --repo-url=git://git.myamlogic.com/tools/repo.git

repo init -u git://aml-code-master.amlogic.com/re...m/manifest.git -b q-fs-release -m google_partner_ref.xml --repo-url=git://git.myamlogic.com/tools/repo.git
---use this
repo init -u git://aml-code-master.amlogic.com/ref-o/platform/manifest.git -b q-fs-release -m google_partner_ref.xml --repo-url=git://git.myamlogic.com/tools/repo.git


am start -n  com.gitvdemo.video/com.gala.video.app.epg.HomeActivity

1.关掉selinux
2.创建目录并修改权限，mkdir /data/tmp; chmod 777 /data/tmp
3.设置节点，setprop media.hls.dumpmode 1
4.打开爱奇艺apk开始播放dv视频，播放一小会退出播放，把/data/tmp/目录下的流发下

am start -n com.google.android.youtube.tv/com.google.android.apps.youtube.tv.activity.MainActivity -d https://www.youtube.com/tv?v=LciyZg78Q40

ffprobe -i $tftpd/nuplayer_hls_dump.ts -show_data -show_packets -select_streams v > v.data

android.hidl.allocator@1.0 android.hidl.memory@1.0 android.hardware.media.omx@1.0


1. ref ffmpeg是怎么更新的
2. 
3. apex amextractor mk->bp



./soong/.intermediates/vendor/amlogic/AmFFmpegAdapter/amextractor/libamextractor/android_arm_armv7-a-neon_cortex-a9_core_shared_com.android.media/libamextractor.so
./soong/.intermediates/vendor/amlogic/AmFFmpegAdapter/amextractor/libamextractor/android_arm_armv7-a-neon_cortex-a9_core_shared_com.android.media/unstripped/libamextractor.so
./soong/.intermediates/vendor/amlogic/AmFFmpegAdapter/amextractor/libamextractor/android_arm_armv7-a-neon_cortex-a9_core_shared/libamextractor.so
./soong/.intermediates/vendor/amlogic/AmFFmpegAdapter/amextractor/libamextractor/android_arm_armv7-a-neon_cortex-a9_core_shared/unstripped/libamextractor.so
./target/product/franklin/symbols/apex/com.android.media/lib/extractors/libamextractor.so
./target/product/franklin/symbols/system/lib/extractors/libamextractor.so
./target/product/franklin/system/apex/com.android.media/lib/extractors/libamextractor.so
./target/product/franklin/system/lib/extractors/libamextractor.so
./target/product/franklin/obj/SHARED_LIBRARIES/com.android.media.libamextractor_intermediates/libamextractor.so
./target/product/franklin/obj/SHARED_LIBRARIES/libamextractor_intermediates/libamextractor.so
./target/product/franklin/obj/SHARED_LIBRARIES/libamextractor_intermediates/LINKED/libamextractor.so
./target/product/ampere/symbols/system/lib/extractors/libamextractor.so
./target/product/ampere/system/lib/extractors/libamextractor.so
./target/product/ampere/obj/SHARED_LIBRARIES/libamextractor_intermediates/libamextractor.so
./target/product/ampere/obj/SHARED_LIBRARIES/libamextractor_intermediates/LINKED/libamextractor.so




http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6520   device/amlogic/franklin/
http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508   frameworks/av/
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/hardware/amlogic/+/6513  hardware
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6512   omx
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6511  ffmpeg
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6499  libmedia


http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508 frameworks/av/
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/hardware/amlogic/+/6513 hardware
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6512 omx
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6511 ffmpeg
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6499 libmedia
http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560  device/amlogic/franklin/
http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6545  frameworks/av/media/mediaserver
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6561 mediaextconfig


1.extractor
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/hardware/amlogic/+/6513 hardware
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6512 omx
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6499 libmedia
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6511 ffmpeg

http://jenkins-sh.amlogic.com:8080/job/android/job/Android_Q/job/Android_Q_Google_ref_PATCHBUILD/1272/


2. extractor + codec_ext
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/hardware/amlogic/+/6513 hardware
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6512 omx
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6499 libmedia
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6511 ffmpeg
http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508   frameworks/av/
http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6520 device/amlogic/franklin/

http://jenkins-sh.amlogic.com:8080/job/android/job/Android_Q/job/Android_Q_Google_ref_PATCHBUILD/1276/


3. extractor + codec_ext + play_ext
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/hardware/amlogic/+/6513 hardware
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6512 omx
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6499 libmedia
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6511 ffmpeg
http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508   frameworks/av/
http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560  device/amlogic/franklin/
http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6545  frameworks/av/media/mediaserver
http://aml-code-master.amlogic.com:8080/c/ref-o/platform/vendor/amlogic/common/+/6561 mediaextconfig

http://jenkins-sh.amlogic.com:8080/job/android/job/Android_Q/job/Android_Q_Google_ref_PATCHBUILD/1274/


20190821
1.加了debug的patch，但是编译的libstagefright.so没有生效


setprop miplayer.debug.level 1
grep -E "word1|word2|word3" 

1.SWPL-7163 Android Q media extension (ongoing)
--目前extractor+player基本版本是ok的，本地简单自测ok
2.TV-8670 [MIUI][R34AE][T920L][5.1][Audio]：Sound Discontinuity When Playing Local DTS Audio (ongoing)
--audiodrop的问题，小米把OMXCodec封装到自己的player接口中，有个线程处理数据的输入+输出，串行执行，大概逻辑是,queueData->audiosink.write->dequeuData->queueData...，目前从log
上看每次queueData的调用周期过长，超过了从pts来看应该有的20ms左右的间隔，原因是audiosink.write写入的是8k数据，40多ms，block，导致queueData的调用周期被拉长。
而且小米反馈单线程的串行调用一直都是这样的，修改的可能性不大。目前还是需要老李从audio方面来分析audiosink write block的原因。
3.SWPL-12847{AV} Android P from trunk20190727, After playing "2017_OLED_杜比惊艳_4K_O_H_0417.ts" for 4 seconds, the picture is freeze, sound is normal 
4.SWPL-12801{AV} Android P After 4K H264 seek, The first 2 seconds of the picture is not smooth Frequency: 10/10 of the times
--本周没有资源看，foucs on mi 920L

920L
10.235.177.192 shiming.lai hc4Zg6j
10.98.17.52 shiming.lai 1
echo  10  > /sys/module/amvdec_h264/parameters/dpb_size_adj
echo 1 > /sys/module/amvdec_h264/parameters/error_recovery_mode



kodi版本17.6 vlc版本1.6.0
asf_1.asf： 
	使用kodi和vlc不卡顿，除了固定点卡顿。使用miplayer基本是播放一小会就卡顿，但cpu idle剩余很多
big_buck_bunny_1080p_VP8_VORBIS_25fps_7800K.WebM：
	使用kodi和vlc不花瓶，使用miplayer是基本一直在花屏
src01_1920x1080_0.075.vp9.mkv：
	使用kodi和vlc都不花屏，但会卡住或卡顿，但miplayer会花屏

软解
1.开启性能模式
echo performance >  scaling_governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
1416000

2.gpu 频率设置成最大744M
echo 3 > /sys/class/mpgpu/scale_mode
cat /sys/class/mpgpu/cur_freq
744


/sys/class/thermal/thermal_zone0/mode

atrace -z -b 40000 sched irq freq idle video binder_driver ss  -t 20 -a *  -o mytrace

atrace -z -b 40000 sched irq freq idle video  ss  -t 20 -a * 

echo performance > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
echo 3 > /sys/class/mpgpu/scale_mode
cat /sys/class/mpgpu/cur_freq
echo 0xf > /sys/module/amvideo/parameters/debug_flag 



1.
09-07 08:49:44.355  3176 10032 I OMX_AmlogicDTSDecoder: OMX_BUFFERFLAG_EOS
09-07 08:49:44.356  3171 10016 I NU-NuPlayerDecoder: [audio] saw output EOS
09-07 08:49:44.357  3171 10015 I NU-NuPlayerRenderer: audio have queued eos, no need to check buffer discontinue
09-07 08:49:44.358  3171 10009 I NU-AmNuPlayer: audio discontinuity: formatChange 1
09-07 08:49:44.358  3171 10016 I NU-NuPlayerDecoder: [doFlush:831] audio flushing 
09-07 08:49:44.358  3171 10016 I NU-NuPlayerDecoder: [doFlush:838] audio flushing 

NU-NuPlayerDecoder: Failed to create audio/ac3 decoder
09-07 10:25:58.104 13495 13523 E NU-AmNuPlayer: received error(0x80000000) from audio decoder, flushing(0), now shutting down
09-07 10:25:58.104 13321 13646 D AmlogicVideoDecoderAwesome:   		  0# Out PTS: 14993172..vf.fd=0, mOutBufferNo=718, frame_num=287
09-07 10:25:58.104 13495 13783 I NU-NuPlayerDecoder: [doFlush:825] audio flushing 
09-07 10:25:58.104 13321 13646 D AmlogicVideoDecoderAwesome: set_info: time 14993172,frame_num 287,handle 0x1c183001
09-07 10:25:58.104 13495 13783 I NU-NuPlayerDecoder: [doFlush:832] audio flushing 
09-07 10:25:58.104 13495 13783 I NU-NuPlayerDecoder: [doFlush:838] audio flushing 
09-07 10:25:58.104 13495 13532 I NU-NuPlayerRenderer: clearAnchorTime
09-07 10:25:58.104 13495 13532 I NU-NuPlayerRenderer: misTrickmode 0
09-07 10:25:58.104 13495 13532 I NU-NuPlayerRenderer: flushing audio
09-07 10:25:58.109 13495 13523 I AmAVUtils: set profile 1668446539 level:0
09-07 10:25:58.109 13495 13523 I AmAVUtils: set default max-input-size to 1887436
09-07 10:25:58.109 13495 13523 I NU-AmNuPlayer: AmNuPlayer::Source::getFormat frame-rate = 24
09-07 10:25:58.109 13495 13523 D NU-AmNuPlayerDriver: notifyListener_l(0xabe2e280), (200, 804, -2147483648, -1), loop setting(0, 0)
09-07 10:25:58.110 13495 13523 D NU-AmNuPlayerDriver: notifyListener_l(0xabe2e280), (211, 0, 0, 20), loop setting(0, 0)
09-07 10:25:58.110 13495 13523 I NU-AmNuPlayer: decoder audio flush completed
09-07 10:25:58.111 13495 13532 I NU-NuPlayerRenderer: PTS: queue[video]:14993172:VJ=0:Aj=0 ,postions 0
09-07 10:25:58.112 11798 12650 W MediaPlayerNative: info/warning (804, -2147483648)
09-07 10:25:58.112 11798 11798 D DuoKanPlayer: onInfo : what = 804, extra = -2147483648
09-07 10:25:58.113 11798 11798 I VideoFragment: onInfo: 804, -2147483648
09-07 10:25:58.115 13495 13523 I NU-AmNuPlayer: audio shutdown completed
09-07 10:25:58.115 13495 13523 I NU-AmNuPlayer: audio setHasNoMedia

media.hls.disable-nuplayer
media.ffmpegextractor.enable



替换mainline的libavenhancements.so到/vendor/lib，进行下面的尝试
1.抽线+bypass di同样能复现
echo 2 > /sys/module/amvideo/parameters/force_vskip_cnt
echo 1 > /sys/module/di/parameters/bypass_all
2. 性能模式无效果，默认的已经是1.4G，最高的cpu频率
echo performance >  scaling_governor
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq
1416000
3.gpu 频率设置成最大，无效果
echo 3 > /sys/class/mpgpu/scale_mode
cat /sys/class/mpgpu/cur_freq
744
4.设置成no audio不能复现
setprop media.amplayer.noaudio true
5. dts passthrough，不使用liscene的dts so，不能复现


echo 0x2 > /sys/module/amvdec_mmpeg4/parameters/debug_enable


ninjia 7
1 在uboot selinux 关了
setenv EnableSelinux permissive;save;reset

2  mount product 分区，删掉原来的apk
mount -rw -o remount /product
rm  /product/app/Netflix/Netflix.apk

3 mount vendor 分区，修改认证版本为ninja7
 vi /vendor/build.prop
 搜索  ro.vendor.nrdp.validation=ninja_6
 修改成ro.vendor.nrdp.validation=ninja_7
 wq ，保存重启
 
 
TV-10691[MIUI][X30A2][T972][9.0][VIDEO]:The video is dead frame about 8s when play MS12 DRC file .(100%)
TV-10675[MIUI][X30A2][T972][9.0][VIDEO]:The picture is not smooth when playing online video "故梦"
TV-10673[MIUI][X30A2][T972][9.0][VIDEO]:The picture is dead frame and has cross striation with sound when playing online video "时髦的秋裤"
TV-10671[MIUI][X30A2][T972][9.0][VIDEO]:"The video frame rate exceeds the support range, press "Return" key to return" displays when playing the local video ”www.5anba.com]2009一級方程式 英國站-週日大獎賽.wmv“
--客户自己解析的及处理的
TV-10665[MIUI][X30A2][T972][9.0][VIDEO]:The local play video “134108-xvid-mp3-704x340-6k-gmc-bf-6m.avi will occur mosaic when playing.
--这种mpeg4的格式，decoder不支持，同TV-4466
TV-10661[MIUI][X30A2][T972][9.0][VIDEO]:The local video "4KVP9_50fps_Mbps_8bit]Wetek-Astra_12343_H_30000-Insight UHD Pearl TV.webm" which carton mosaic and green stripe when playing for several minutes.
TV-10659[MIUI][X30A2][T972][9.0][AML-620][Video]:Part of of flv format video can't play.(100%, X301 OK)
TV-10657[MIUI][X30A2][T972][9.0][VIDEO]:The picture of the local video "gonein60sec_1200.avi" will be stucked and sound is normal when seeking, exiting and replay it again, there is only sound withound picture.
TV-10600[MIUI][X30A2][T972][9.0][VIDEO]:The video named "Miyavi.-.[Rockin&#39;.mama.festival.vol.1(050925)].asf" will keep the original picture for several seconds before the sound has been updated to the latest seek point when seeking the video.


TV-10579[MIUI][X32A7][T84M][9.0][AML-625][VIDEO]:The video occasionally carton mosaic when playing local video which is VP9 8K.
TV-10568[MIUI][R33A8][T950X][9.0][AML-626][Video]:Local playback "H.264 AVC [6791kbps&29.970fps]25.000fps Andy.Lau. Concert.avi", Audio/Video is not synchronized when starting playback.[100% ]
TV-10352[MIUI][R33A8][T950X][9.0][Feedback][AML-608][Video]:Play LG.4K.DEMO_Chess_HEVC_60FPS_10bit_HDR.ts source, video card when starting[80%, R311 NG]
TV-10690[MIUI][R34AE][T920L][5.1][AML-634][Video]:The video will occur "loading buffer circle" when playing.
--可能是apk没有播放起来，需要log分析
TV-10525[MIUI][R34AE][T920L][5.1][AML-624][Video]:The content of the “智能摄像机” is black and sometimes the TV source such as the HDMI content is dead frame.
TV-10631[MIUI][R33A8][T950X][9.0][Feedback][AML-627][Video]: Play "H.264 AVC [6791kbps&29.970fps]25.000fps Andy.Lau. Concert.avi", stuck in the playing interface.[Once, R311 OK]

TV-10044[MIUI][R34AE][T920L][5.1][Video]: The local video 00031.m2ts can not play fluently.
TV-10032[MIUI][X30A2][T972][9.0][AML-570][Video]:Local video play error.
TV-9847[MIUI][R34AE][T920L][5.1][Video]: The local video stucks after repeatedly playing and pressing Home key to the main interface.
TV-9825[P355][T962][6.0][Feedback][AML-520][Video]:Play online video, switch to the next episode, appear a short time.
TV-9810[MIUI][X30A2][T972][9.0][AML-448][Video]:Picture was not smooth when play AVI_MPEG4+MPEG_1920x1080_29.97fps_6832kbps_S0V1A1_00.04.04.avi.(100%, T962 is ok)
TV-9701 [MIUI][X32A7][T972][9.0][AML-523][Video];TV had sound and blacklight and no picture when play local video.


1. 进入external/chromium-trace目录，连接网络adb
2.播放出现问题时使用下面的指令抓20秒的trace，生成trace的时间内，需要包含有问题的
python systrace.py -t 20 -o mynewtrace.html sched freq idle am wm gfx view video binder_driver hal dalvik input res


while true; do logcat > logcat_`date +%Y%m%d_%H-%M-%S`; done

echo dump `cat /sys/class/vfm/map | grep "(1)" | awk '{ print $4 }' | sed -n 's/\(.*\)(.*/\1/p'` > /sys/class/vfm/map
cat /sys/class/vdec/dump_vdec_chunks



1.ffmpeg这个帮建立个q的分支
http://aml-code-master.amlogic.com:8080/#/admin/projects/ref-o/vendor/amlogic/frameworks/av,branches
2.vendor/amlogic/frameworks/av这个目前没有分支，帮建立个q分支
http://aml-code-master.amlogic.com:8080/#/admin/projects/ref-o/vendor/amlogic/frameworks/av,branches

cat bootorg.img > /dev/block/boot && sync && reboot

#看出第二路一直在drop
echo 0x4000000 > /sys/module/amvideo/parameters/debug_flag

echo 0x14000000 > /sys/module/amvideo/parameters/debug_flag

echo 0x14400000 > /sys/module/amvideo/parameters/debug_flag

echo 0x400000 > /sys/module/amvideo/parameters/debug_flag

pip sync toggle: http://scgit.amlogic.com:8080/87572

echo 7 > /sys/module/videosync/parameters/vp_debug_flag



"have hardware/amlogic/media"
"have hardware/amlogic/media"
[ 99% 408/409] finishing build rules ...
FAILED: 
bootable/recovery/updater/Android.mk: error: "updater (EXECUTABLES android-arm) missing libsecurity (STATIC_LIBRARIES android-arm)" 
You can set ALLOW_MISSING_DEPENDENCIES=true in your environment if this is intentional, but that may defer real problems until later in the build.
build/make/core/main.mk:1008: error: exiting from previous errors.
10:27:03 ckati failed with: exit status 1

1.这个需要创建个Q的分支
	git://git.myamlogic.com/vendor/amlogic/frameworks/av
2. AmFFmpegAdapter基于下面的提交创建个q分支
	commit dd82cff3c5f5be136ce4a3d3db34e6b1b46b4008
	Change-Id：I7af4694fd3e6bd534a2535384083925b9f6aa61e
	amffmpegadapter: not put divx to blacklist [1/1]
3. 这两个需要创建q分支
	git://git.myamlogic.com/vendor/amlogic/prebuilt/libmedia
	git://git.myamlogic.com/vendor/amlogic/prebuilt/libstagefright

#VDA
common
http://scgit.amlogic.com:8080/#/c/85323/
http://scgit.amlogic.com:8080/#/c/84088/  ==》 88293
media_modules：
http://scgit.amlogic.com:8080/#/c/83441/
media_hal：
http://scgit.amlogic.com:8080/#/c/82474/

device：
http://scgit.amlogic.com:8080/#/c/84090/    ==》 88292 + 88362

omx：
http://scgit.amlogic.com:8080/#/c/82794/  88723(omx+vda so)

media.omx.support.omx2



1.manifest
2.frameworks/av   http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508
mediaserver ext  http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/7015
3.vendor/frameworks/av   http://scgit.amlogic.com:8080/87869
4.libmedia  http://scgit.amlogic.com:8080/88193
5.libstagefright  http://scgit.amlogic.com:8080/#/c/88199/
6. common ignore  http://scgit.amlogic.com:8080/87899
7.ffmpeg    http://scgit.amlogic.com:8080/#/c/83056/
8.devices  http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560  extplayer

extractor  7163
1.manifest  http://aml-code-master.amlogic.com:8080/c/ref-o/platform/manifest/+/7088
2.ffmpeg    http://scgit.amlogic.com:8080/#/c/83056/
3. ignore http://scgit.amlogic.com:8080/87899

extractor_codec_ext

codec ext
4.http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508

player
1.devices  http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560  
2. framework mediaserver http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/7015 
3. vendor/framework  http://scgit.amlogic.com:8080/87869
4.libmedia
5.libstagefright
http://scgit.amlogic.com:8080/#/c/87979/

http://scgit.amlogic.com:8080/#/c/88020/   Q amnuplaer
http://scgit.amlogic.com:8080/#/c/88191/   Q extractor
http://scgit.amlogic.com:8080/88196   Q omx


manifest: http://aml-code-master.amlogic.com:8080/c/ref-o/platform/manifest/+/7088
ffmpeg: http://scgit.amlogic.com:8080/#/c/83056/
vendor/framwork/av http://scgit.amlogic.com:8080/87869


-------need review
1.manifest  http://aml-code-master.amlogic.com:8080/c/ref-o/platform/manifest/+/7088
2.ffmpeg    http://scgit.amlogic.com:8080/#/c/83056/ ---已merge
3.frameworks/av   http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/6508

4. device franklin   http://scgit.amlogic.com:8080/#/c/88841/
5. device netwn      http://scgit.amlogic.com:8080/88252
6  vendor/frameworks/av http://scgit.amlogic.com:8080/#/c/88271/   ---已merge
7. common app invoke ffmepg extractor    http://scgit.amlogic.com:8080/#/c/88551/
8. commmon so        http://scgit.amlogic.com:8080/#/c/87979/

source：
http://scgit.amlogic.com:8080/#/c/88020/   Q amnuplaer
http://scgit.amlogic.com:8080/#/c/88191/   Q extractor
http://scgit.amlogic.com:8080/88196   Q omx


player
1.vendor/frameworks/av   http://scgit.amlogic.com:8080/#/c/88271/    3/5
2. framework mediaserver http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/7015 xxxx no use
.libmedia  http://scgit.amlogic.com:8080/88193   xxxxxxxxxxxxx
.libstagefright  http://scgit.amlogic.com:8080/#/c/88199/ xxxxxxxxx
3. http://scgit.amlogic.com:8080/#/c/87979/   omx + player
4.devices  http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560
--------------------------////////////////////////////////
http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560  1
http://scgit.amlogic.com:8080/88252 2 
http://scgit.amlogic.com:8080/#/c/87869/ xxx 3
http://aml-code-master.amlogic.com:8080/c/pdk-o/platform/frameworks/av/+/7015  no use
http://scgit.amlogic.com:8080/#/c/87979/

http://aml-code-master.amlogic.com:8080/c/ref-o/device/amlogic/franklin/+/6560  1
http://scgit.amlogic.com:8080/88252 2



source:
http://scgit.amlogic.com:8080/#/c/88020/   Q amnuplaer
http://scgit.amlogic.com:8080/#/c/88191/   Q extractor
http://scgit.amlogic.com:8080/88196   Q omx


http://scgit.amlogic.com:8080/88226 remote so

http://scgit.amlogic.com:8080/88551 force ffmpeg


		
		chmod +x device/amlogic/common/quick_build_kernel.sh
	2. 编译
		export KERNEL_A32_SUPPORT=false;export TARGET_KERNEL_BUILT_FROM_SOURCE=true;
		export BOARD_AML_VENDOR_PATH=vendor/amlogic/common/;export TOP=$PWD;
		device/amlogic/common/quick_build_kernel.sh build-modules
		
		
				atrace -z -b 20000 sched irq freq idle video binder_driver -t 10 -a \"*\" -o /data/local/tmp/trace1;
	循环抓只保留最后多少内存的数据
		echo 0 > /sys/class/debug/atrace_tag
		echo 1 > /sys/class/debug/atrace_tag
		echo 2 > /sys/class/debug/atrace_tag
		echo 3 > /sys/class/debug/atrace_tag
			cat /sys/class/debug/atrace_tag
	
gfx input view webview wm am sm audio  video 
camera hal res dalvik rs bionic power pm ss database network adb vibrator
 aidl pdx sched irq i2c freq idle disk mmc load sync workq memreclaim regulators binder_driver binder_lock pagecache
 
		播放开始的时候
		echo 1 > /sys/kernel/debug/tracing/events/meson_atrace/enable
		atrace -b 25000 sched irq freq idle video gfx input view webview sync binder_driver --async_start -o /data/local/tmp/trace1

		出问题之后
		atrace --async_stop -o /data/local/tmp/trace1


echo 1 > /sys/module/amvdec_ports/parameters/aml_vcodec_dbg;
echo 2 > /sys/module/amvdec_ports/parameters/aml_v4l2_dbg_level;
echo 1 > /sys/module/v4l2_mem2mem/parameters/debug;
echo 1 > /sys/module/videobuf_res/parameters/debug;
echo 1 > /sys/module/videobuf2_core/parameters/debug;
echo 1 > /sys/module/videobuf_core/parameters/debug;
echo 1 > /sys/module/videobuf2_v4l2/parameters/debug;
echo 1 > /sys/module/amvdec_mh264/parameters/h264_debug_flag
echo 1 > /sys/class/video4linux/video26/dev_debug
echo 8 > /proc/sys/kernel/printk;


echo 0x0010 > /sys/module/amvdec_mh264/parameters/h264_debug_flag


帮忙用下面的code 1952确认下，我本地已经确认是可以的
1. divx是因为版权问题不支持的，divx流正常情况是不能播放的，会提示“Un Supported Video”
2. VP6，rmvb可以正常播放，提供的ogm流是divx会出现有声音没有画面
http://jenkins-sh.amlogic.com:8080/job/android/job/Android_Q/job/Android_Q_Google_ref_PATCHBUILD/1952/


media.hls.disable-nuplayer
media.ffmpegextractor.enable

pm disable com.google.android.tungsten.setupwraith;
settings put secure user_setup_complete 1;
settings put secure tv_user_setup_complete 1;
settings put global device_provisioned 1


$(BOARD_AML_VENDOR_PATH)/prebuilt/libstagefrighthw/lib/libvideo_dec.so:$(TARGET_COPY_OUT_VENDOR)/lib/libvideo_dec.so


file name  video type    width height 


1.TV-11490 [MIUI][X30A2][T972][9.0][Video]The video "00001.m2ts" will occur black screen but has sound when playing at the first time.
----没有复现
2.TV-7143 [X30A2][T972][9.0][Video]:The thumbnails appear green and there are a lot of mosaics
----需要复现
3.TV-8750[X30A2][T972][9.0][Video]:PIP display last frame local video picture when exit local video to lanucher.(100%, X301 NG)
----重复bug？？
4.TV-10661 [SWPL-14914][MIUI][X30A2][T972][9.0][VIDEO]:The local video "4KVP9_50fps_Mbps_8bit]Wetek-Astra_12343_H_30000-Insight UHD Pearl TV.webm" which carton mosaic and green stripe when playing for several minutes.




1.默认的omx 255 打开，把kernel log 和logcat提供下，如果不能分析出问题时就需要使用下面方法来进一步定位问题
setprop media.omx.log_levels 255

2.小米使用自己player的平台比如972 出现黑屏，卡顿不流畅、静帧问题时，再复现时抓log方法
1）copy scratch-logcat-toyb-59fps-kernel-all.sh到/data目录，
并修改权限 chmod +x scratch-logcat-toyb-59fps-kernel-all.sh
2) cd到/data目录，开始播放前执行./scratch-logcat-toyb-59fps-kernel-all.sh
出现问题后（dump完decoder的一些信息可以推出播放），退出播放，等待超过40s后，使用下面命令把log都打包，把生成的log-1.tar.gz提供下
tar cvfz log-1.tar.gz k_* logcat.log
note: 
	a) 出现问题后，不要再进行其它操作（退出播放除外），比如seek，再播放其它片源
    b）fae可以使用此wiki来dump信息，http://wiki-china.amlogic.com/Media/%e5%a4%9a%e5%aa%92%e4%bd%93%e7%9b%b8%e5%85%b3%e7%9f%a5%e8%af%86/%e5%a4%9a%e8%b7%af%e8%a7%a3%e7%a0%81%e9%97%ae%e9%a2%98%e5%88%86%e6%9e%90
	c）如果上面的log不能定位是小米问题还是我们的问题时，需要替换些so之类的，替换这后也是用上面的方法抓log

3.小米使用我们的player的平台，比如960x，950x 出现黑屏，卡顿不流畅、静帧问题时，如果RD不能使用公版复现问题，再复现时请使用下面的方法
抓log方法
1）设置相关属性
   setprop media.hls.ptsdebug 8
2）使用同样使用2中说的方法抓log

4.花屏马赛克问题分析一般需要dump流来分析
  mkdir /data/tmp/
  setenforce 0
  chmod 777 /data/tmp/
  setprop media.omx.dumpCodec true
  

两个原因造成fail
1）开始进入播放的时候，

am start -n com.netflix.ninja/com.netflix.ninja.MainActivity -a android.intent.action.VIEW -d 'https://www.netflix.com/watch/80996905?source=99'

ffmpeg -re -i F:/08.flv -vcodec copy -acodec copy -f flv rtmp://localhost:1935/live/stream


rtsp://10.68.13.188:8554/live

        deleted:    Am-Hdcpadaptor/Android.mk
        modified:   Am-Httplive/Android.mk
        modified:   Am-mpeg2ts/Android.mk
        modified:   AmFFmpegExtractor.h
        modified:   AmFFmpegSource.cpp
        modified:   AmFFmpegSource.h
		
		
http://10.68.13.188:8554/dv/zion.dm1_U25000.ts

		
http://10.68.13.188:8554/dv/zion.dm1_U25000.ts

http://10.68.11.62:8800/dv/zion.dm1_U25000.ts


http://10.68.11.62:8800/dv/zion.dm1_U25000.ts

wplay http://10.68.11.62:8800/dv/index1.m3u8

udp://239.1.1.1:8210

nts问题
1）SWPL-11287 SWPL-9821 Netflix Ninja 7 feature integration-Fast Playback Requirements
   SWPL-15813 {NTS}Run netlfix Automated test case,PLAY-LAT-XXX-XXX-XXX, DEL-PLAY-LAT-XXX-XXX-XXX, 48 test cases fail
   ----这个是目前卡在audio的问题
2）SWPL-15976 [NTS][Manual]FPSTART-24FPS-HR-AL1/H264-DDP51 failed step 10,timeout
	---这个已经有patch，同SWPL-15397
3）SWPL-15994 Netflix Ninja 7 feature integration-Fast Playback Requirements-LASTFRAME-DISPLAY-UNDERFLOW-*
   SWPL-15968 [NTS][Manual]LASTFRAME-DISPLAY-UNDERFLOW-AL1-HEAAC failed step 11,not display all the frames
	--同一问题
4）SWPL-15987[NTS][Manual]EP:DRS-AUDIO-AL1-23FPS-ATMOS/DDP5.1-DWN/UP exist 1-2 times freeze;Frequency:3/3
   SWPL-15951[NTS][Adhoc]standby/resume,video can't playback
   SWPL-15949 NTS}[Adhoc]HD(H264) Video,Pause/play playback,exist freeze
   ---264的play相关问题
5）SWPL-15806 {NTS}Netflix APK, play ATMOS source, switch from AMTOS to stereo output, AVSync is not synchronized
   ---同步问题，可能已经好了

Q播放问题
1） SWPL-16636 {A/V} Android Q can not user gallery to play every network protocol streaming. Frequency: 10/10 of the times comparison: android P is normal
	SWPL-16439 CLONE - {A/V} Android Q not support HLS AVS streaming Probability: 10/10 of the times comparison: android P is normal
	---应该是同一问题，目前网络下载不下来
2）SWPL-16497 {A/V} Android Q Need to support UDP / RTSP / RTP protocol streaming player Frequency: 10/10 of the times comparison: android P is normal
   ---需要port下rts的source
3）SWPL-15012{AC214}{Android Q}{A/V}movieplayer apk defaults used the osd layer, the image is poor,video layer should be used；block PQ testing;(100%);contrast:Android P OK
   ----需要强制video播放的问题

   
media.ffmpegextractor.enable false
setprop media.hls.disable-nuplayer true


setprop media.omx.out_buffer2_360 6
echo 0x200 > /sys/module/amvdec_vp9/parameters/double_write_mode
chmod 444 /sys/module/amvdec_vp9/parameters/double_write_mode

echo 4 > /sys/module/decoder_common/parameters/debug






















